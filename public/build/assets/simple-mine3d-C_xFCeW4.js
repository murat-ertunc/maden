import{R as W,l as c,m as pe,Q as j,n as L,L as N,f,g as y,B as re,e as ge,M as r,o as te,p as T,q as Ve,r as G,s as me,j as Se,E as Le,t as De,u as Ye,S as He,C as oe,P as Xe,W as Re,v as Fe,b as Ge,O as Qe,A as Ze,D as $e,H as qe,w as Ne,x as le,G as We,V as ce,k as Pe,y as z,i as Ue,z as Ee,I as Ce,J as X,K as R}from"./OrbitControls-CN_YdCdl.js";const B=new W,b=new c,_=new c,g=new j,we={X:new c(1,0,0),Y:new c(0,1,0),Z:new c(0,0,1)},he={type:"change"},ye={type:"mouseDown"},fe={type:"mouseUp",mode:null},be={type:"objectChange"};class Ke extends pe{constructor(e,t){super(),t===void 0&&(console.warn('THREE.TransformControls: The second parameter "domElement" is now mandatory.'),t=document),this.isTransformControls=!0,this.visible=!1,this.domElement=t,this.domElement.style.touchAction="none";const i=new st;this._gizmo=i,this.add(i);const s=new ot;this._plane=s,this.add(s);const o=this;function n(v,D){let Y=D;Object.defineProperty(o,v,{get:function(){return Y!==void 0?Y:D},set:function(A){Y!==A&&(Y=A,s[v]=A,i[v]=A,o.dispatchEvent({type:v+"-changed",value:A}),o.dispatchEvent(he))}}),o[v]=D,s[v]=D,i[v]=D}n("camera",e),n("object",void 0),n("enabled",!0),n("axis",null),n("mode","translate"),n("translationSnap",null),n("rotationSnap",null),n("scaleSnap",null),n("space","world"),n("size",1),n("dragging",!1),n("showX",!0),n("showY",!0),n("showZ",!0);const a=new c,l=new c,p=new j,w=new j,d=new c,h=new j,F=new c,E=new c,C=new c,x=0,I=new c;n("worldPosition",a),n("worldPositionStart",l),n("worldQuaternion",p),n("worldQuaternionStart",w),n("cameraPosition",d),n("cameraQuaternion",h),n("pointStart",F),n("pointEnd",E),n("rotationAxis",C),n("rotationAngle",x),n("eye",I),this._offset=new c,this._startNorm=new c,this._endNorm=new c,this._cameraScale=new c,this._parentPosition=new c,this._parentQuaternion=new j,this._parentQuaternionInv=new j,this._parentScale=new c,this._worldScaleStart=new c,this._worldQuaternionInv=new j,this._worldScale=new c,this._positionStart=new c,this._quaternionStart=new j,this._scaleStart=new c,this._getPointer=Je.bind(this),this._onPointerDown=tt.bind(this),this._onPointerHover=et.bind(this),this._onPointerMove=it.bind(this),this._onPointerUp=nt.bind(this),this.domElement.addEventListener("pointerdown",this._onPointerDown),this.domElement.addEventListener("pointermove",this._onPointerHover),this.domElement.addEventListener("pointerup",this._onPointerUp)}updateMatrixWorld(){this.object!==void 0&&(this.object.updateMatrixWorld(),this.object.parent===null?console.error("TransformControls: The attached 3D object must be a part of the scene graph."):this.object.parent.matrixWorld.decompose(this._parentPosition,this._parentQuaternion,this._parentScale),this.object.matrixWorld.decompose(this.worldPosition,this.worldQuaternion,this._worldScale),this._parentQuaternionInv.copy(this._parentQuaternion).invert(),this._worldQuaternionInv.copy(this.worldQuaternion).invert()),this.camera.updateMatrixWorld(),this.camera.matrixWorld.decompose(this.cameraPosition,this.cameraQuaternion,this._cameraScale),this.camera.isOrthographicCamera?this.camera.getWorldDirection(this.eye).negate():this.eye.copy(this.cameraPosition).sub(this.worldPosition).normalize(),super.updateMatrixWorld(this)}pointerHover(e){if(this.object===void 0||this.dragging===!0)return;B.setFromCamera(e,this.camera);const t=de(this._gizmo.picker[this.mode],B);t?this.axis=t.object.name:this.axis=null}pointerDown(e){if(!(this.object===void 0||this.dragging===!0||e.button!==0)&&this.axis!==null){B.setFromCamera(e,this.camera);const t=de(this._plane,B,!0);t&&(this.object.updateMatrixWorld(),this.object.parent.updateMatrixWorld(),this._positionStart.copy(this.object.position),this._quaternionStart.copy(this.object.quaternion),this._scaleStart.copy(this.object.scale),this.object.matrixWorld.decompose(this.worldPositionStart,this.worldQuaternionStart,this._worldScaleStart),this.pointStart.copy(t.point).sub(this.worldPositionStart)),this.dragging=!0,ye.mode=this.mode,this.dispatchEvent(ye)}}pointerMove(e){const t=this.axis,i=this.mode,s=this.object;let o=this.space;if(i==="scale"?o="local":(t==="E"||t==="XYZE"||t==="XYZ")&&(o="world"),s===void 0||t===null||this.dragging===!1||e.button!==-1)return;B.setFromCamera(e,this.camera);const n=de(this._plane,B,!0);if(n){if(this.pointEnd.copy(n.point).sub(this.worldPositionStart),i==="translate")this._offset.copy(this.pointEnd).sub(this.pointStart),o==="local"&&t!=="XYZ"&&this._offset.applyQuaternion(this._worldQuaternionInv),t.indexOf("X")===-1&&(this._offset.x=0),t.indexOf("Y")===-1&&(this._offset.y=0),t.indexOf("Z")===-1&&(this._offset.z=0),o==="local"&&t!=="XYZ"?this._offset.applyQuaternion(this._quaternionStart).divide(this._parentScale):this._offset.applyQuaternion(this._parentQuaternionInv).divide(this._parentScale),s.position.copy(this._offset).add(this._positionStart),this.translationSnap&&(o==="local"&&(s.position.applyQuaternion(g.copy(this._quaternionStart).invert()),t.search("X")!==-1&&(s.position.x=Math.round(s.position.x/this.translationSnap)*this.translationSnap),t.search("Y")!==-1&&(s.position.y=Math.round(s.position.y/this.translationSnap)*this.translationSnap),t.search("Z")!==-1&&(s.position.z=Math.round(s.position.z/this.translationSnap)*this.translationSnap),s.position.applyQuaternion(this._quaternionStart)),o==="world"&&(s.parent&&s.position.add(b.setFromMatrixPosition(s.parent.matrixWorld)),t.search("X")!==-1&&(s.position.x=Math.round(s.position.x/this.translationSnap)*this.translationSnap),t.search("Y")!==-1&&(s.position.y=Math.round(s.position.y/this.translationSnap)*this.translationSnap),t.search("Z")!==-1&&(s.position.z=Math.round(s.position.z/this.translationSnap)*this.translationSnap),s.parent&&s.position.sub(b.setFromMatrixPosition(s.parent.matrixWorld))));else if(i==="scale"){if(t.search("XYZ")!==-1){let a=this.pointEnd.length()/this.pointStart.length();this.pointEnd.dot(this.pointStart)<0&&(a*=-1),_.set(a,a,a)}else b.copy(this.pointStart),_.copy(this.pointEnd),b.applyQuaternion(this._worldQuaternionInv),_.applyQuaternion(this._worldQuaternionInv),_.divide(b),t.search("X")===-1&&(_.x=1),t.search("Y")===-1&&(_.y=1),t.search("Z")===-1&&(_.z=1);s.scale.copy(this._scaleStart).multiply(_),this.scaleSnap&&(t.search("X")!==-1&&(s.scale.x=Math.round(s.scale.x/this.scaleSnap)*this.scaleSnap||this.scaleSnap),t.search("Y")!==-1&&(s.scale.y=Math.round(s.scale.y/this.scaleSnap)*this.scaleSnap||this.scaleSnap),t.search("Z")!==-1&&(s.scale.z=Math.round(s.scale.z/this.scaleSnap)*this.scaleSnap||this.scaleSnap))}else if(i==="rotate"){this._offset.copy(this.pointEnd).sub(this.pointStart);const a=20/this.worldPosition.distanceTo(b.setFromMatrixPosition(this.camera.matrixWorld));let l=!1;t==="XYZE"?(this.rotationAxis.copy(this._offset).cross(this.eye).normalize(),this.rotationAngle=this._offset.dot(b.copy(this.rotationAxis).cross(this.eye))*a):(t==="X"||t==="Y"||t==="Z")&&(this.rotationAxis.copy(we[t]),b.copy(we[t]),o==="local"&&b.applyQuaternion(this.worldQuaternion),b.cross(this.eye),b.length()===0?l=!0:this.rotationAngle=this._offset.dot(b.normalize())*a),(t==="E"||l)&&(this.rotationAxis.copy(this.eye),this.rotationAngle=this.pointEnd.angleTo(this.pointStart),this._startNorm.copy(this.pointStart).normalize(),this._endNorm.copy(this.pointEnd).normalize(),this.rotationAngle*=this._endNorm.cross(this._startNorm).dot(this.eye)<0?1:-1),this.rotationSnap&&(this.rotationAngle=Math.round(this.rotationAngle/this.rotationSnap)*this.rotationSnap),o==="local"&&t!=="E"&&t!=="XYZE"?(s.quaternion.copy(this._quaternionStart),s.quaternion.multiply(g.setFromAxisAngle(this.rotationAxis,this.rotationAngle)).normalize()):(this.rotationAxis.applyQuaternion(this._parentQuaternionInv),s.quaternion.copy(g.setFromAxisAngle(this.rotationAxis,this.rotationAngle)),s.quaternion.multiply(this._quaternionStart).normalize())}this.dispatchEvent(he),this.dispatchEvent(be)}}pointerUp(e){e.button===0&&(this.dragging&&this.axis!==null&&(fe.mode=this.mode,this.dispatchEvent(fe)),this.dragging=!1,this.axis=null)}dispose(){this.domElement.removeEventListener("pointerdown",this._onPointerDown),this.domElement.removeEventListener("pointermove",this._onPointerHover),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.traverse(function(e){e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose()})}attach(e){return this.object=e,this.visible=!0,this}detach(){return this.object=void 0,this.visible=!1,this.axis=null,this}reset(){this.enabled&&this.dragging&&(this.object.position.copy(this._positionStart),this.object.quaternion.copy(this._quaternionStart),this.object.scale.copy(this._scaleStart),this.dispatchEvent(he),this.dispatchEvent(be),this.pointStart.copy(this.pointEnd))}getRaycaster(){return B}getMode(){return this.mode}setMode(e){this.mode=e}setTranslationSnap(e){this.translationSnap=e}setRotationSnap(e){this.rotationSnap=e}setScaleSnap(e){this.scaleSnap=e}setSize(e){this.size=e}setSpace(e){this.space=e}}function Je(u){if(this.domElement.ownerDocument.pointerLockElement)return{x:0,y:0,button:u.button};{const e=this.domElement.getBoundingClientRect();return{x:(u.clientX-e.left)/e.width*2-1,y:-(u.clientY-e.top)/e.height*2+1,button:u.button}}}function et(u){if(this.enabled)switch(u.pointerType){case"mouse":case"pen":this.pointerHover(this._getPointer(u));break}}function tt(u){this.enabled&&(document.pointerLockElement||this.domElement.setPointerCapture(u.pointerId),this.domElement.addEventListener("pointermove",this._onPointerMove),this.pointerHover(this._getPointer(u)),this.pointerDown(this._getPointer(u)))}function it(u){this.enabled&&this.pointerMove(this._getPointer(u))}function nt(u){this.enabled&&(this.domElement.releasePointerCapture(u.pointerId),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.pointerUp(this._getPointer(u)))}function de(u,e,t){const i=e.intersectObject(u,!0);for(let s=0;s<i.length;s++)if(i[s].object.visible||t)return i[s];return!1}const ie=new Le,m=new c(0,1,0),ve=new c(0,0,0),Me=new De,ne=new j,ae=new j,O=new c,xe=new De,$=new c(1,0,0),V=new c(0,1,0),q=new c(0,0,1),se=new c,Q=new c,Z=new c;class st extends pe{constructor(){super(),this.isTransformControlsGizmo=!0,this.type="TransformControlsGizmo";const e=new L({depthTest:!1,depthWrite:!1,fog:!1,toneMapped:!1,transparent:!0}),t=new N({depthTest:!1,depthWrite:!1,fog:!1,toneMapped:!1,transparent:!0}),i=e.clone();i.opacity=.15;const s=t.clone();s.opacity=.5;const o=e.clone();o.color.setHex(16711680);const n=e.clone();n.color.setHex(65280);const a=e.clone();a.color.setHex(255);const l=e.clone();l.color.setHex(16711680),l.opacity=.5;const p=e.clone();p.color.setHex(65280),p.opacity=.5;const w=e.clone();w.color.setHex(255),w.opacity=.5;const d=e.clone();d.opacity=.25;const h=e.clone();h.color.setHex(16776960),h.opacity=.25,e.clone().color.setHex(16776960);const E=e.clone();E.color.setHex(7895160);const C=new f(0,.04,.1,12);C.translate(0,.05,0);const x=new y(.08,.08,.08);x.translate(0,.04,0);const I=new re;I.setAttribute("position",new ge([0,0,0,1,0,0],3));const v=new f(.0075,.0075,.5,3);v.translate(0,.25,0);function D(S,U){const P=new G(S,.0075,3,64,U*Math.PI*2);return P.rotateY(Math.PI/2),P.rotateX(Math.PI/2),P}function Y(){const S=new re;return S.setAttribute("position",new ge([0,0,0,1,1,1],3)),S}const A={X:[[new r(C,o),[.5,0,0],[0,0,-Math.PI/2]],[new r(C,o),[-.5,0,0],[0,0,Math.PI/2]],[new r(v,o),[0,0,0],[0,0,-Math.PI/2]]],Y:[[new r(C,n),[0,.5,0]],[new r(C,n),[0,-.5,0],[Math.PI,0,0]],[new r(v,n)]],Z:[[new r(C,a),[0,0,.5],[Math.PI/2,0,0]],[new r(C,a),[0,0,-.5],[-Math.PI/2,0,0]],[new r(v,a),null,[Math.PI/2,0,0]]],XYZ:[[new r(new te(.1,0),d.clone()),[0,0,0]]],XY:[[new r(new y(.15,.15,.01),w.clone()),[.15,.15,0]]],YZ:[[new r(new y(.15,.15,.01),l.clone()),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new r(new y(.15,.15,.01),p.clone()),[.15,0,.15],[-Math.PI/2,0,0]]]},Ie={X:[[new r(new f(.2,0,.6,4),i),[.3,0,0],[0,0,-Math.PI/2]],[new r(new f(.2,0,.6,4),i),[-.3,0,0],[0,0,Math.PI/2]]],Y:[[new r(new f(.2,0,.6,4),i),[0,.3,0]],[new r(new f(.2,0,.6,4),i),[0,-.3,0],[0,0,Math.PI]]],Z:[[new r(new f(.2,0,.6,4),i),[0,0,.3],[Math.PI/2,0,0]],[new r(new f(.2,0,.6,4),i),[0,0,-.3],[-Math.PI/2,0,0]]],XYZ:[[new r(new te(.2,0),i)]],XY:[[new r(new y(.2,.2,.01),i),[.15,.15,0]]],YZ:[[new r(new y(.2,.2,.01),i),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new r(new y(.2,.2,.01),i),[.15,0,.15],[-Math.PI/2,0,0]]]},Oe={START:[[new r(new te(.01,2),s),null,null,null,"helper"]],END:[[new r(new te(.01,2),s),null,null,null,"helper"]],DELTA:[[new T(Y(),s),null,null,null,"helper"]],X:[[new T(I,s.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new T(I,s.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new T(I,s.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},Te={XYZE:[[new r(D(.5,1),E),null,[0,Math.PI/2,0]]],X:[[new r(D(.5,.5),o)]],Y:[[new r(D(.5,.5),n),null,[0,0,-Math.PI/2]]],Z:[[new r(D(.5,.5),a),null,[0,Math.PI/2,0]]],E:[[new r(D(.75,1),h),null,[0,Math.PI/2,0]]]},je={AXIS:[[new T(I,s.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]]},ke={XYZE:[[new r(new Ve(.25,10,8),i)]],X:[[new r(new G(.5,.1,4,24),i),[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new r(new G(.5,.1,4,24),i),[0,0,0],[Math.PI/2,0,0]]],Z:[[new r(new G(.5,.1,4,24),i),[0,0,0],[0,0,-Math.PI/2]]],E:[[new r(new G(.75,.1,2,24),i)]]},_e={X:[[new r(x,o),[.5,0,0],[0,0,-Math.PI/2]],[new r(v,o),[0,0,0],[0,0,-Math.PI/2]],[new r(x,o),[-.5,0,0],[0,0,Math.PI/2]]],Y:[[new r(x,n),[0,.5,0]],[new r(v,n)],[new r(x,n),[0,-.5,0],[0,0,Math.PI]]],Z:[[new r(x,a),[0,0,.5],[Math.PI/2,0,0]],[new r(v,a),[0,0,0],[Math.PI/2,0,0]],[new r(x,a),[0,0,-.5],[-Math.PI/2,0,0]]],XY:[[new r(new y(.15,.15,.01),w),[.15,.15,0]]],YZ:[[new r(new y(.15,.15,.01),l),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new r(new y(.15,.15,.01),p),[.15,0,.15],[-Math.PI/2,0,0]]],XYZ:[[new r(new y(.1,.1,.1),d.clone())]]},ze={X:[[new r(new f(.2,0,.6,4),i),[.3,0,0],[0,0,-Math.PI/2]],[new r(new f(.2,0,.6,4),i),[-.3,0,0],[0,0,Math.PI/2]]],Y:[[new r(new f(.2,0,.6,4),i),[0,.3,0]],[new r(new f(.2,0,.6,4),i),[0,-.3,0],[0,0,Math.PI]]],Z:[[new r(new f(.2,0,.6,4),i),[0,0,.3],[Math.PI/2,0,0]],[new r(new f(.2,0,.6,4),i),[0,0,-.3],[-Math.PI/2,0,0]]],XY:[[new r(new y(.2,.2,.01),i),[.15,.15,0]]],YZ:[[new r(new y(.2,.2,.01),i),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new r(new y(.2,.2,.01),i),[.15,0,.15],[-Math.PI/2,0,0]]],XYZ:[[new r(new y(.2,.2,.2),i),[0,0,0]]]},Ae={X:[[new T(I,s.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new T(I,s.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new T(I,s.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]};function k(S){const U=new pe;for(const P in S)for(let H=S[P].length;H--;){const M=S[P][H][0].clone(),K=S[P][H][1],J=S[P][H][2],ee=S[P][H][3],Be=S[P][H][4];M.name=P,M.tag=Be,K&&M.position.set(K[0],K[1],K[2]),J&&M.rotation.set(J[0],J[1],J[2]),ee&&M.scale.set(ee[0],ee[1],ee[2]),M.updateMatrix();const ue=M.geometry.clone();ue.applyMatrix4(M.matrix),M.geometry=ue,M.renderOrder=1/0,M.position.set(0,0,0),M.rotation.set(0,0,0),M.scale.set(1,1,1),U.add(M)}return U}this.gizmo={},this.picker={},this.helper={},this.add(this.gizmo.translate=k(A)),this.add(this.gizmo.rotate=k(Te)),this.add(this.gizmo.scale=k(_e)),this.add(this.picker.translate=k(Ie)),this.add(this.picker.rotate=k(ke)),this.add(this.picker.scale=k(ze)),this.add(this.helper.translate=k(Oe)),this.add(this.helper.rotate=k(je)),this.add(this.helper.scale=k(Ae)),this.picker.translate.visible=!1,this.picker.rotate.visible=!1,this.picker.scale.visible=!1}updateMatrixWorld(e){const i=(this.mode==="scale"?"local":this.space)==="local"?this.worldQuaternion:ae;this.gizmo.translate.visible=this.mode==="translate",this.gizmo.rotate.visible=this.mode==="rotate",this.gizmo.scale.visible=this.mode==="scale",this.helper.translate.visible=this.mode==="translate",this.helper.rotate.visible=this.mode==="rotate",this.helper.scale.visible=this.mode==="scale";let s=[];s=s.concat(this.picker[this.mode].children),s=s.concat(this.gizmo[this.mode].children),s=s.concat(this.helper[this.mode].children);for(let o=0;o<s.length;o++){const n=s[o];n.visible=!0,n.rotation.set(0,0,0),n.position.copy(this.worldPosition);let a;if(this.camera.isOrthographicCamera?a=(this.camera.top-this.camera.bottom)/this.camera.zoom:a=this.worldPosition.distanceTo(this.cameraPosition)*Math.min(1.9*Math.tan(Math.PI*this.camera.fov/360)/this.camera.zoom,7),n.scale.set(1,1,1).multiplyScalar(a*this.size/4),n.tag==="helper"){n.visible=!1,n.name==="AXIS"?(n.visible=!!this.axis,this.axis==="X"&&(g.setFromEuler(ie.set(0,0,0)),n.quaternion.copy(i).multiply(g),Math.abs(m.copy($).applyQuaternion(i).dot(this.eye))>.9&&(n.visible=!1)),this.axis==="Y"&&(g.setFromEuler(ie.set(0,0,Math.PI/2)),n.quaternion.copy(i).multiply(g),Math.abs(m.copy(V).applyQuaternion(i).dot(this.eye))>.9&&(n.visible=!1)),this.axis==="Z"&&(g.setFromEuler(ie.set(0,Math.PI/2,0)),n.quaternion.copy(i).multiply(g),Math.abs(m.copy(q).applyQuaternion(i).dot(this.eye))>.9&&(n.visible=!1)),this.axis==="XYZE"&&(g.setFromEuler(ie.set(0,Math.PI/2,0)),m.copy(this.rotationAxis),n.quaternion.setFromRotationMatrix(Me.lookAt(ve,m,V)),n.quaternion.multiply(g),n.visible=this.dragging),this.axis==="E"&&(n.visible=!1)):n.name==="START"?(n.position.copy(this.worldPositionStart),n.visible=this.dragging):n.name==="END"?(n.position.copy(this.worldPosition),n.visible=this.dragging):n.name==="DELTA"?(n.position.copy(this.worldPositionStart),n.quaternion.copy(this.worldQuaternionStart),b.set(1e-10,1e-10,1e-10).add(this.worldPositionStart).sub(this.worldPosition).multiplyScalar(-1),b.applyQuaternion(this.worldQuaternionStart.clone().invert()),n.scale.copy(b),n.visible=this.dragging):(n.quaternion.copy(i),this.dragging?n.position.copy(this.worldPositionStart):n.position.copy(this.worldPosition),this.axis&&(n.visible=this.axis.search(n.name)!==-1));continue}n.quaternion.copy(i),this.mode==="translate"||this.mode==="scale"?(n.name==="X"&&Math.abs(m.copy($).applyQuaternion(i).dot(this.eye))>.99&&(n.scale.set(1e-10,1e-10,1e-10),n.visible=!1),n.name==="Y"&&Math.abs(m.copy(V).applyQuaternion(i).dot(this.eye))>.99&&(n.scale.set(1e-10,1e-10,1e-10),n.visible=!1),n.name==="Z"&&Math.abs(m.copy(q).applyQuaternion(i).dot(this.eye))>.99&&(n.scale.set(1e-10,1e-10,1e-10),n.visible=!1),n.name==="XY"&&Math.abs(m.copy(q).applyQuaternion(i).dot(this.eye))<.2&&(n.scale.set(1e-10,1e-10,1e-10),n.visible=!1),n.name==="YZ"&&Math.abs(m.copy($).applyQuaternion(i).dot(this.eye))<.2&&(n.scale.set(1e-10,1e-10,1e-10),n.visible=!1),n.name==="XZ"&&Math.abs(m.copy(V).applyQuaternion(i).dot(this.eye))<.2&&(n.scale.set(1e-10,1e-10,1e-10),n.visible=!1)):this.mode==="rotate"&&(ne.copy(i),m.copy(this.eye).applyQuaternion(g.copy(i).invert()),n.name.search("E")!==-1&&n.quaternion.setFromRotationMatrix(Me.lookAt(this.eye,ve,V)),n.name==="X"&&(g.setFromAxisAngle($,Math.atan2(-m.y,m.z)),g.multiplyQuaternions(ne,g),n.quaternion.copy(g)),n.name==="Y"&&(g.setFromAxisAngle(V,Math.atan2(m.x,m.z)),g.multiplyQuaternions(ne,g),n.quaternion.copy(g)),n.name==="Z"&&(g.setFromAxisAngle(q,Math.atan2(m.y,m.x)),g.multiplyQuaternions(ne,g),n.quaternion.copy(g))),n.visible=n.visible&&(n.name.indexOf("X")===-1||this.showX),n.visible=n.visible&&(n.name.indexOf("Y")===-1||this.showY),n.visible=n.visible&&(n.name.indexOf("Z")===-1||this.showZ),n.visible=n.visible&&(n.name.indexOf("E")===-1||this.showX&&this.showY&&this.showZ),n.material._color=n.material._color||n.material.color.clone(),n.material._opacity=n.material._opacity||n.material.opacity,n.material.color.copy(n.material._color),n.material.opacity=n.material._opacity,this.enabled&&this.axis&&(n.name===this.axis||this.axis.split("").some(function(l){return n.name===l}))&&(n.material.color.setHex(16776960),n.material.opacity=1)}super.updateMatrixWorld(e)}}class ot extends r{constructor(){super(new me(1e5,1e5,2,2),new L({visible:!1,wireframe:!0,side:Se,transparent:!0,opacity:.1,toneMapped:!1})),this.isTransformControlsPlane=!0,this.type="TransformControlsPlane"}updateMatrixWorld(e){let t=this.space;switch(this.position.copy(this.worldPosition),this.mode==="scale"&&(t="local"),se.copy($).applyQuaternion(t==="local"?this.worldQuaternion:ae),Q.copy(V).applyQuaternion(t==="local"?this.worldQuaternion:ae),Z.copy(q).applyQuaternion(t==="local"?this.worldQuaternion:ae),m.copy(Q),this.mode){case"translate":case"scale":switch(this.axis){case"X":m.copy(this.eye).cross(se),O.copy(se).cross(m);break;case"Y":m.copy(this.eye).cross(Q),O.copy(Q).cross(m);break;case"Z":m.copy(this.eye).cross(Z),O.copy(Z).cross(m);break;case"XY":O.copy(Z);break;case"YZ":O.copy(se);break;case"XZ":m.copy(Z),O.copy(Q);break;case"XYZ":case"E":O.set(0,0,0);break}break;case"rotate":default:O.set(0,0,0)}O.length()===0?this.quaternion.copy(this.cameraQuaternion):(xe.lookAt(b.set(0,0,0),O,m),this.quaternion.setFromRotationMatrix(xe)),super.updateMatrixWorld(e)}}class at{constructor(e,t,i,s=null){this.scene=e,this.camera=t,this.renderer=i,this.viewer=s,this.isCreating=!1,this.previewObject=null,this.currentType="tunnel",this.currentPosition=new c(0,-2,0),this.parameters={tunnel:{width:3,height:3,length:10,orientation:"horizontal",angle:0},road:{width:4,height:.5,length:15,orientation:"horizontal",angle:0},rail:{width:1.5,height:.3,length:20,orientation:"horizontal",angle:0},conveyor:{width:1,height:.8,length:12,orientation:"horizontal",angle:0}},this.createdObjects=new Map,this.nextId=1}startCreating(e){this.isCreating=!0,this.currentType=e,this.showCreationUI(),this.createPreview(),console.log(`[MineObjectCreator] Started creating: ${e}`)}stopCreating(){this.isCreating=!1,this.hideCreationUI(),this.removePreview(),console.log("[MineObjectCreator] Stopped creating")}updateParameter(e,t){this.parameters[this.currentType]&&(e==="orientation"?this.parameters[this.currentType][e]=t:this.parameters[this.currentType][e]=parseFloat(t),this.updatePreview(),console.log(`[MineObjectCreator] Updated ${e}: ${t}`))}createPreview(){this.removePreview();const e=this.parameters[this.currentType],t=this.createGeometry(this.currentType,e),i=this.createPreviewMaterial(this.currentType);this.previewObject=new r(t,i),this.previewObject.position.copy(this.currentPosition),this.previewObject.name="preview_object",this.scene.add(this.previewObject)}updatePreview(){if(this.previewObject){const e=this.parameters[this.currentType],t=this.createGeometry(this.currentType,e);this.previewObject.geometry.dispose(),this.previewObject.geometry=t}}removePreview(){this.previewObject&&(this.scene.remove(this.previewObject),this.previewObject.geometry.dispose(),this.previewObject.material.dispose(),this.previewObject=null)}createGeometry(e,t){let i;switch(e){case"tunnel":t.orientation==="vertical"?(i=new f(t.width/2,t.width/2,t.length,16,1,!1),t.angle&&t.angle!==0&&i.rotateY(t.angle*Math.PI/180)):(i=new f(t.height/2,t.height/2,t.length,16,1,!1),t.angle&&t.angle!==0&&i.rotateY(t.angle*Math.PI/180),i.rotateX(Math.PI/2),i.scale(t.width/t.height,1,1));break;case"road":i=new y(t.width,t.height,t.length);break;case"rail":i=new y(t.width,t.height,t.length);break;case"conveyor":i=new y(t.width,t.height,t.length);break;default:i=new y(2,2,2)}return e!=="tunnel"&&t.angle&&t.angle!==0&&(t.orientation==="vertical"?i.rotateY(t.angle*Math.PI/180):i.rotateZ(t.angle*Math.PI/180)),i}createPreviewMaterial(e){const t={tunnel:8421504,road:4210752,rail:6710886,conveyor:16766720};return new z({color:t[e]||8421504,transparent:!0,opacity:.6,wireframe:!1})}finalizeCreation(){if(!this.previewObject)return null;const e=this.parameters[this.currentType],t=this.createGeometry(this.currentType,e),i=this.createFinalMaterial(this.currentType),s=new r(t,i);return s.position.copy(this.previewObject.position),s.userData={id:this.nextId++,type:this.currentType,parameters:{...e},selectable:!0},this.scene.add(s),this.createdObjects.set(s.userData.id,s),this.removePreview(),console.log(`[MineObjectCreator] Created ${this.currentType} with ID: ${s.userData.id}`),s}createFinalMaterial(e){const t={tunnel:8421504,road:4210752,rail:6710886,conveyor:16766720};return new z({color:t[e]||8421504,transparent:!1,opacity:1})}showCreationUI(){let e=document.getElementById("creation-panel");e||(e=this.createCreationPanel()),e.style.display="block",this.updateUIForType(this.currentType)}hideCreationUI(){const e=document.getElementById("creation-panel");e&&(e.style.display="none")}createCreationPanel(){const e=document.createElement("div");return e.id="creation-panel",e.className="creation-panel",e.style.cssText=`
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            min-width: 280px;
            z-index: 1000;
            display: none;
            font-family: Arial, sans-serif;
        `,e.innerHTML=`
            <h4 id="creation-title" style="margin-top: 0; color: #fff;">Tünel Oluştur</h4>
            
            <div class="parameter-group" style="margin-bottom: 15px;">
                <label for="param1" style="display: block; margin-bottom: 5px;">
                    Genişlik: <span id="param1-value" style="color: #4CAF50; font-weight: bold;">3</span>m
                </label>
                <input type="range" id="param1" min="1" max="10" step="0.5" value="3" 
                       style="width: 100%; margin-bottom: 5px;">
                <input type="number" id="param1-number" min="1" max="10" step="0.5" value="3"
                       style="width: 100%; padding: 4px; margin-bottom: 10px; background: #333; color: white; border: 1px solid #555; border-radius: 3px;">
                
                <label for="param2" style="display: block; margin-bottom: 5px;">
                    Yükseklik: <span id="param2-value" style="color: #4CAF50; font-weight: bold;">3</span>m
                </label>
                <input type="range" id="param2" min="1" max="8" step="0.5" value="3"
                       style="width: 100%; margin-bottom: 5px;">
                <input type="number" id="param2-number" min="1" max="8" step="0.5" value="3"
                       style="width: 100%; padding: 4px; margin-bottom: 10px; background: #333; color: white; border: 1px solid #555; border-radius: 3px;">
                
                <label for="param3" style="display: block; margin-bottom: 5px;">
                    Uzunluk: <span id="param3-value" style="color: #4CAF50; font-weight: bold;">10</span>m
                </label>
                <input type="range" id="param3" min="5" max="5000" step="1" value="10"
                       style="width: 100%; margin-bottom: 5px;">
                <input type="number" id="param3-number" min="5" max="5000" step="1" value="10"
                       style="width: 100%; padding: 4px; margin-bottom: 15px; background: #333; color: white; border: 1px solid #555; border-radius: 3px;">
            </div>
            
            <div id="tunnel-controls" class="tunnel-specific" style="margin-bottom: 15px; border-top: 1px solid #444; padding-top: 15px;">
                <label for="orientation" style="display: block; margin-bottom: 5px;">
                    Yönelim:
                </label>
                <select id="orientation" style="width: 100%; padding: 5px; margin-bottom: 10px; background: #333; color: white; border: 1px solid #555;">
                    <option value="horizontal">Yatay</option>
                    <option value="vertical">Dikey</option>
                </select>
                
                <label for="angle" style="display: block; margin-bottom: 5px;">
                    Açı: <span id="angle-value" style="color: #4CAF50; font-weight: bold;">0</span>°
                </label>
                <input type="range" id="angle" min="0" max="360" step="5" value="0"
                       style="width: 100%; margin-bottom: 10px;">
            </div>
            
            <div class="button-group" style="margin-top: 15px;">
                <button id="create-confirm" class="btn btn-success" 
                        style="background: #4CAF50; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-right: 10px; cursor: pointer;">
                    Oluştur
                </button>
                <button id="create-cancel" class="btn btn-secondary"
                        style="background: #666; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                    İptal
                </button>
            </div>
        `,document.body.appendChild(e),this.setupCreationPanelEvents(),e}setupCreationPanelEvents(){const e=document.getElementById("param1"),t=document.getElementById("param2"),i=document.getElementById("param3"),s=document.getElementById("param1-number"),o=document.getElementById("param2-number"),n=document.getElementById("param3-number"),a=document.getElementById("orientation"),l=document.getElementById("angle"),p=document.getElementById("create-confirm"),w=document.getElementById("create-cancel");e.addEventListener("input",d=>{const h=d.target.value;document.getElementById("param1-value").textContent=h,s.value=h,this.updateParameter("width",h)}),t.addEventListener("input",d=>{const h=d.target.value;document.getElementById("param2-value").textContent=h,o.value=h,this.updateParameter("height",h)}),i.addEventListener("input",d=>{const h=d.target.value;document.getElementById("param3-value").textContent=h,n.value=h,this.updateParameter("length",h)}),s.addEventListener("input",d=>{const h=d.target.value;document.getElementById("param1-value").textContent=h,e.value=h,this.updateParameter("width",h)}),o.addEventListener("input",d=>{const h=d.target.value;document.getElementById("param2-value").textContent=h,t.value=h,this.updateParameter("height",h)}),n.addEventListener("input",d=>{const h=d.target.value;document.getElementById("param3-value").textContent=h,i.value=h,this.updateParameter("length",h)}),a.addEventListener("change",d=>{this.updateParameter("orientation",d.target.value)}),l.addEventListener("input",d=>{document.getElementById("angle-value").textContent=d.target.value,this.updateParameter("angle",d.target.value)}),p.addEventListener("click",()=>{const d=this.finalizeCreation();d&&(this.stopCreating(),this.viewer&&this.viewer.saveObjectToServer(d))}),w.addEventListener("click",()=>{this.stopCreating()})}updateUIForType(e){const t={tunnel:"Tünel Oluştur",road:"Yol Oluştur",rail:"Ray Oluştur",conveyor:"Konveyör Oluştur"};document.getElementById("creation-title").textContent=t[e]||"Obje Oluştur";const i=this.parameters[e];document.getElementById("param1").value=i.width,document.getElementById("param1-value").textContent=i.width,document.getElementById("param1-number").value=i.width,document.getElementById("param2").value=i.height,document.getElementById("param2-value").textContent=i.height,document.getElementById("param2-number").value=i.height,document.getElementById("param3").value=i.length,document.getElementById("param3-value").textContent=i.length,document.getElementById("param3-number").value=i.length;const s=document.getElementById("tunnel-controls");e==="tunnel"?(s.style.display="block",document.getElementById("orientation").value=i.orientation||"horizontal",document.getElementById("angle").value=i.angle||0,document.getElementById("angle-value").textContent=i.angle||0):s.style.display="none"}async saveToServer(e){var t,i,s;try{const o={mine_id:this.mineId||1,name:`${e.userData.type.charAt(0).toUpperCase()+e.userData.type.slice(1)} ${e.userData.id}`,type:"model",geometry:{type:e.userData.type,...e.userData.parameters},material:{color:e.material.color.getHex(),opacity:e.material.opacity||1},position:[e.position.x,e.position.y,e.position.z],rotation:[e.rotation.x,e.rotation.y,e.rotation.z],scale:[e.scale.x,e.scale.y,e.scale.z],properties:{createdAt:new Date().toISOString(),tool:e.userData.type},visible:!0,order:e.userData.id},n=await fetch(`/api/mines/${this.mineId||1}/models`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":((t=document.querySelector('meta[name="csrf-token"]'))==null?void 0:t.getAttribute("content"))||"",Accept:"application/json"},body:JSON.stringify(o)});if(n.ok){const a=await n.json();e.userData.serverId=(i=a.data)==null?void 0:i.id,console.log("[MineObjectCreator] Successfully saved to server:",a)}else throw new Error(`HTTP ${n.status}: ${n.statusText}`)}catch(o){console.error("[MineObjectCreator] Error saving to server:",o),(s=this.showError)==null||s.call(this,"Obje kaydedilemedi: "+o.message)}}showError(e){const t=document.createElement("div");t.style.cssText=`
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #ff4444;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 10000;
        `,t.textContent=e,document.body.appendChild(t),setTimeout(()=>{document.body.removeChild(t)},3e3)}}class rt{constructor(e,t,i){this.scene=e,this.camera=t,this.renderer=i,this.isDrawing=!1,this.currentPath=[],this.tempPath=null,this.paths=new Map,this.raycaster=new W,this.mouse=new ce,this.groundPlane=new Pe(new c(0,1,0),-2),this.tunnelConstraintMode=!1,this.constraintTunnel=null,this.currentDrawingType="tunnel",this.previewMesh=null,this.distanceLabel=null,this.drawingCallbacks={onPathStart:null,onPathUpdate:null,onPathComplete:null}}startDrawing(e={}){this.stopDrawing(),this.isDrawing=!0,this.currentPath=[],this.drawingCallbacks={...this.drawingCallbacks,...e},console.log("[MinePathDrawer] Yol çizimi başladı - state temizlendi, type:",this.currentDrawingType)}setDrawingType(e){this.currentDrawingType=e,console.log("[MinePathDrawer] Drawing type set to:",e)}setAxisConstraint(e){this.axisConstraint=e,console.log("[MinePathDrawer] Axis constraint set to:",e)}stopDrawing(){this.isDrawing=!1,this.currentPath=[],this.removeTempPath(),this.removePreviewMesh(),this.removeDistanceLabel(),console.log("[MinePathDrawer] Yol çizimi durdu - temizlik yapıldı")}handleClick(e){if(!this.isDrawing)return;this.updateMousePosition(e);const t=this.getGroundIntersection();t&&(this.currentPath.push(t),this.updateTempPath(),this.drawingCallbacks.onPathUpdate&&this.drawingCallbacks.onPathUpdate(this.currentPath))}handleMouseMove(e){if(!this.isDrawing||this.currentPath.length===0)return;this.updateMousePosition(e);let t=this.getGroundIntersection();if(t){if(this.axisConstraint&&this.currentPath.length>0){const s=this.currentPath[this.currentPath.length-1];switch(this.axisConstraint){case"x":t.y=s.y,t.z=s.z;break;case"y":t.x=s.x,t.z=s.z;break;case"z":t.x=s.x,t.y=s.y;break}}this.viewer.constrainToAxis&&(t=this.viewer.constrainToAxis(t)),this.updatePreview(t);const i=[...this.currentPath,t];this.updateTempPath(i)}}updateMousePosition(e){const t=this.renderer.domElement.getBoundingClientRect();this.mouse.x=(e.clientX-t.left)/t.width*2-1,this.mouse.y=-((e.clientY-t.top)/t.height)*2+1}getGroundIntersection(){this.raycaster.setFromCamera(this.mouse,this.camera);const e=new c;if(this.tunnelConstraintMode&&this.constraintTunnel){const t=this.raycaster.intersectObject(this.constraintTunnel,!0);if(t.length>0){const i=t[0].point;return i.y=-2.5,console.log("[MinePathDrawer] Tunnel constraint intersection found:",{x:i.x.toFixed(2),y:i.y.toFixed(2),z:i.z.toFixed(2)}),i}else return console.log("[MinePathDrawer] No tunnel constraint intersection found"),null}else return this.raycaster.ray.intersectPlane(this.groundPlane,e)?(console.log("[MinePathDrawer] Ground intersection found:",{x:e.x.toFixed(2),y:e.y.toFixed(2),z:e.z.toFixed(2)}),e):(console.log("[MinePathDrawer] No ground intersection found"),null)}updateTempPath(e=null){this.removeTempPath();const t=e||this.currentPath;if(t.length<2)return;const i=new re().setFromPoints(t),s=new N({color:16711680,linewidth:3,opacity:.8,transparent:!0});this.tempPath=new T(i,s),this.scene.add(this.tempPath)}removeTempPath(){this.tempPath&&(console.log("[MinePathDrawer] Removing temp path"),this.scene.remove(this.tempPath),this.tempPath.geometry.dispose(),this.tempPath.material.dispose(),this.tempPath=null)}completePath(){if(this.currentPath.length<2)return console.log("[MinePathDrawer] Complete path failed: not enough points"),null;console.log("[MinePathDrawer] Completing path with",this.currentPath.length,"points"),this.removeTempPath(),this.drawingCallbacks.onPathComplete&&this.drawingCallbacks.onPathComplete(this.currentPath);const e=[...this.currentPath];return this.currentPath=[],e}createPath(e){const{id:t,points:i,width:s=2.5,height:o=2.5,color:n="#808080",type:a="tunnel"}=e;if(!i||i.length<2)return null;const l=this.createPathMesh(i,s,o,n,a);return l.userData={id:t,type:a,pathData:e},this.paths.set(t,l),this.scene.add(l),console.log(`[MinePathDrawer] Yol oluşturuldu: ${t}, boyutlar: ${s}x${o}`),l}createPathMesh(e,t,i,s,o){const n=new Ue,a=this.createTubeGeometry(e,t,i),l=this.createPathMaterial(s,o),p=new r(a,l);if(p.castShadow=!0,p.receiveShadow=!0,n.add(p),o==="tunnel"){const F=new z({color:new oe(s).multiplyScalar(.8),transparent:!0,opacity:.9,shininess:10}),E=new r(a.clone(),F);E.scale.set(.95,.95,.95),n.add(E)}const w=new Ee(a),d=new N({color:new oe(s).multiplyScalar(.5),opacity:.6,transparent:!0,linewidth:1}),h=new Ce(w,d);return n.add(h),o==="conveyor"?this.addConveyorBelt(n,e,t):o==="rail"&&this.addRailTracks(n,e,t),n}createPathMaterial(e,t){const i=new oe(e);switch(t){case"tunnel":return new z({color:i,transparent:!0,opacity:.9,shininess:30,specular:4473924});case"road":return new le({color:i.multiplyScalar(.7),transparent:!0,opacity:.95});case"rail":return new z({color:i,metalness:.7,roughness:.3,transparent:!0,opacity:.9});case"conveyor":return new z({color:i,transparent:!0,opacity:.8,shininess:50,specular:8947848});default:return new le({color:i,transparent:!0,opacity:.9})}}createTubeGeometry(e,t,i){if(e.length<2)return new y(1,1,1);const s=new X(e);s.tension=.2;const o=Math.max(e.length*6,24),n=16,a=new R(s,o,Math.max(t,i)/2,n,!1),l=a.attributes.position.array;for(let p=0;p<l.length;p+=3){const w=l[p],d=l[p+1],h=l[p+2];if(Math.sqrt(w*w+h*h)>0){const E=Math.atan2(h,w),x=t*i/Math.sqrt((i*Math.cos(E))**2+(t*Math.sin(E))**2)/(Math.max(t,i)/2);l[p]=w*x,l[p+2]=h*x,d<0&&(l[p+1]=d*.8)}}return a.attributes.position.needsUpdate=!0,a.computeVertexNormals(),a}addConveyorBelt(e,t,i){const s=new X(t),o=new R(s,t.length*2,i/3,8,!1),n=new z({color:3355443,shininess:100,transparent:!0,opacity:.8}),a=new r(o,n);a.position.y+=.1,e.add(a)}addRailTracks(e,t,i){const s=new X(t),o=new R(s,t.length*4,.05,6,!1),n=new z({color:6710886,metalness:.8,roughness:.2}),a=new r(o,n.clone());a.position.x-=i/3,a.position.y+=.05,e.add(a);const l=new r(o.clone(),n.clone());l.position.x+=i/3,l.position.y+=.05,e.add(l)}removePath(e){const t=this.paths.get(e);t&&(this.scene.remove(t),t.traverse(i=>{i.geometry&&i.geometry.dispose(),i.material&&(Array.isArray(i.material)?i.material.forEach(s=>s.dispose()):i.material.dispose())}),this.paths.delete(e),console.log(`[MinePathDrawer] Yol silindi: ${e}`))}clearAllPaths(){for(const[e,t]of this.paths)this.removePath(e);console.log("[MinePathDrawer] Tüm yollar silindi")}getPath(e){return this.paths.get(e)}getAllPaths(){return Array.from(this.paths.values())}calculatePathLength(e){if(!e||e.length<2)return 0;let t=0;for(let i=1;i<e.length;i++){const s=e[i-1],o=e[i],n=o.x-s.x,a=o.y-s.y,l=o.z-s.z;t+=Math.sqrt(n*n+a*a+l*l)}return t}enableTunnelConstraint(e){this.tunnelConstraintMode=!0,this.constraintTunnel=e,console.log("[MinePathDrawer] Tunnel constraint mode enabled")}disableTunnelConstraint(){this.tunnelConstraintMode=!1,this.constraintTunnel=null,console.log("[MinePathDrawer] Tunnel constraint mode disabled")}updatePreview(e){if(!this.isDrawing||this.currentPath.length===0)return;const t=[...this.currentPath,e];this.createPreviewMesh(t),this.updateDistanceLabel(e)}createPreviewMesh(e){if(this.removePreviewMesh(),e.length<2)return;let t,i;switch(this.currentDrawingType){case"tunnel":t=this.createTubeGeometry(e,2.5,2.5),i=new L({color:6710886,transparent:!0,opacity:.3,wireframe:!0});break;case"road":t=this.createRoadGeometry(e,3),i=new L({color:3355443,transparent:!0,opacity:.4});break;case"rail":t=this.createRailGeometry(e,1.5),i=new L({color:6710886,transparent:!0,opacity:.5});break;case"conveyor":t=this.createConveyorGeometry(e,1),i=new L({color:4473924,transparent:!0,opacity:.4});break;default:t=new re().setFromPoints(e),i=new N({color:16711680,transparent:!0,opacity:.7})}this.currentDrawingType==="tunnel"||this.currentDrawingType==="road"||this.currentDrawingType==="rail"||this.currentDrawingType==="conveyor"?this.previewMesh=new r(t,i):this.previewMesh=new T(t,i),this.scene.add(this.previewMesh)}removePreviewMesh(){this.previewMesh&&(this.scene.remove(this.previewMesh),this.previewMesh.geometry&&this.previewMesh.geometry.dispose(),this.previewMesh.material&&this.previewMesh.material.dispose(),this.previewMesh=null)}updateDistanceLabel(e){if(this.currentPath.length===0)return;const i=this.currentPath[this.currentPath.length-1].distanceTo(e);this.updateDistanceDisplay(i)}updateDistanceDisplay(e){const t=document.getElementById("distance-display"),i=document.getElementById("distance-value");t&&i&&(t.style.display="block",i.textContent=`${e.toFixed(1)}m`)}removeDistanceLabel(){const e=document.getElementById("distance-display");e&&(e.style.display="none")}createRoadGeometry(e,t){const i=new X(e);return new R(i,e.length*2,t/2,8,!1)}createRailGeometry(e,t){const i=new X(e);return new R(i,e.length*2,.1,6,!1)}createConveyorGeometry(e,t){const i=new X(e);return new R(i,e.length*2,t/2,6,!1)}}class lt{constructor(e,t,i){this.scene=e,this.camera=t,this.renderer=i,this.raycaster=new W,this.mouse=new ce,this.selectedObject=null,this.selectableObjects=new Set,this.highlightMaterial=new L({color:16729156,transparent:!0,opacity:.3,depthTest:!1}),this.outlineColor=16711680,this.xrayModeObject=null,this.originalMaterials=new Map,this.callbacks={onObjectSelect:null,onObjectDeselect:null,onObjectDelete:null}}setCallbacks(e){this.callbacks={...this.callbacks,...e}}addSelectableObject(e,t={}){e.userData.selectable=!0,e.userData.objectData=t,this.selectableObjects.add(e)}removeSelectableObject(e){this.selectableObjects.delete(e),this.selectedObject===e&&this.deselectObject()}handleClick(e){this.updateMousePosition(e),this.raycaster.setFromCamera(this.mouse,this.camera);const t=Array.from(this.selectableObjects),i=this.raycaster.intersectObjects(t,!0);if(i.length>0){let s=null;for(const o of i){let n=o.object;for(;n&&!n.userData.selectable;)n=n.parent;if(n&&this.selectableObjects.has(n)){s=n;break}}s&&this.selectObject(s)}else this.deselectObject()}updateMousePosition(e){const t=this.renderer.domElement.getBoundingClientRect();this.mouse.x=(e.clientX-t.left)/t.width*2-1,this.mouse.y=-((e.clientY-t.top)/t.height)*2+1}selectObject(e){if(this.selectedObject===e){e.userData.objectData&&e.userData.objectData.pathType==="tunnel"&&this.toggleXRayMode(e);return}this.deselectObject(),this.selectedObject=e,this.addHighlight(e),e.userData.objectData&&e.userData.objectData.pathType==="tunnel"&&this.enableXRayMode(e),this.callbacks.onObjectSelect&&this.callbacks.onObjectSelect(e,e.userData.objectData)}deselectObject(){this.selectedObject&&(this.removeHighlight(this.selectedObject),this.disableXRayMode(),this.callbacks.onObjectDeselect&&this.callbacks.onObjectDeselect(this.selectedObject),this.selectedObject=null)}deleteSelectedObject(){if(this.selectedObject){const e=this.selectedObject;this.deselectObject(),this.callbacks.onObjectDelete&&this.callbacks.onObjectDelete(e)}}addHighlight(e){e.traverse(t=>{if(t.isMesh&&t.geometry){const i=new Ee(t.geometry),s=new Ce(i,new N({color:this.outlineColor,linewidth:3}));s.name="highlight_outline",t.add(s)}})}removeHighlight(e){e.traverse(t=>{const i=t.getObjectByName("highlight_outline");i&&(t.remove(i),i.geometry.dispose(),i.material.dispose())})}getSelectedObject(){return this.selectedObject}clearSelection(){this.deselectObject()}enableXRayMode(e){this.xrayModeObject!==e&&(this.disableXRayMode(),this.xrayModeObject=e,e.traverse(t=>{if(t.isMesh){this.originalMaterials.set(t,t.material.clone());const i=t.material.clone();i.transparent=!0,i.opacity=.3,i.side=Se,t.material=i}}),console.log("[ObjectSelector] X-Ray mode enabled for tunnel"))}disableXRayMode(){this.xrayModeObject&&(this.xrayModeObject.traverse(e=>{e.isMesh&&this.originalMaterials.has(e)&&(e.material.dispose(),e.material=this.originalMaterials.get(e),this.originalMaterials.delete(e))}),this.xrayModeObject=null,console.log("[ObjectSelector] X-Ray mode disabled"))}toggleXRayMode(e){this.xrayModeObject===e?this.disableXRayMode():this.enableXRayMode(e)}}class ct{constructor(e,t){if(console.log("%c[SimpleMine3DViewer] Constructor called","color: blue; font-weight: bold;"),console.log("[SimpleMine3DViewer] Parameters:",{containerId:e,mineId:t}),this.containerId=e,this.mineId=t,this.container=document.getElementById(e),console.log("[SimpleMine3DViewer] Container element:",this.container),!this.container){const i=`Container with id "${e}" not found`;throw console.error("[SimpleMine3DViewer]",i),new Error(i)}console.log("[SimpleMine3DViewer] THREE.js (ESM) version:",Ye),this.scene=null,this.camera=null,this.renderer=null,this.controls=null,this.pathDrawer=null,this.objectCreator=null,this.transformControls=null,this.isPathDrawingMode=!1,this.isCreatingMode=!1,this.selectedObject=null,this.objectSelector=null,console.log("[SimpleMine3DViewer] Starting initialization..."),this.init()}async init(){try{console.log("%c[SimpleMine3DViewer] Initializing 3D system...","color: green; font-weight: bold;");const e=document.getElementById("loading-container");e&&(e.style.opacity="0",e.style.pointerEvents="none",e.style.transition="opacity .3s",setTimeout(()=>{e&&(e.style.display="none")},350)),this.container.style.display="block",console.log("[SimpleMine3DViewer] Container dimensions:",{clientWidth:this.container.clientWidth,clientHeight:this.container.clientHeight,offsetWidth:this.container.offsetWidth,offsetHeight:this.container.offsetHeight}),(this.container.clientWidth===0||this.container.clientHeight===0)&&console.warn("[SimpleMine3DViewer] Container has zero dimensions, using default sizes"),console.log("[SimpleMine3DViewer] Creating scene..."),this.scene=new He,this.scene.background=new oe(8900331),console.log("[SimpleMine3DViewer] Scene created:",this.scene),console.log("[SimpleMine3DViewer] Creating camera...");const t=this.container.clientWidth/this.container.clientHeight||16/9;this.camera=new Xe(60,t,.1,500),this.camera.position.set(15,5,25),this.camera.lookAt(0,-2,0),console.log("[SimpleMine3DViewer] Camera created:",{fov:this.camera.fov,aspect:this.camera.aspect,position:this.camera.position,near:this.camera.near,far:this.camera.far}),console.log("[SimpleMine3DViewer] Creating renderer..."),this.renderer=new Re({antialias:!0,alpha:!0,powerPreference:"high-performance"});const i=this.container.clientWidth||800,s=this.container.clientHeight||600;this.renderer.setSize(i,s),this.renderer.setPixelRatio(Math.min(window.devicePixelRatio,2)),this.renderer.shadowMap.enabled=!1,this.renderer.toneMapping=Fe,this.renderer.toneMappingExposure=1.2,this.renderer.outputColorSpace=Ge,this.renderer.domElement.style.width="100%",this.renderer.domElement.style.height="100%",this.renderer.domElement.style.display="block",this.renderer.domElement.style.position="relative",console.log("[SimpleMine3DViewer] Renderer created:",{width:i,height:s,shadowMap:this.renderer.shadowMap.enabled,toneMapping:this.renderer.toneMapping,domElement:this.renderer.domElement}),console.log("[SimpleMine3DViewer] Appending renderer to container..."),this.container.appendChild(this.renderer.domElement),console.log("[SimpleMine3DViewer] Renderer appended successfully"),console.log("[SimpleMine3DViewer] Adding lights..."),this.addLights(),console.log("[SimpleMine3DViewer] Adding test geometry..."),this.addTestGeometry(),console.log("[SimpleMine3DViewer] Setting up controls..."),this.controls=new Qe(this.camera,this.renderer.domElement),this.controls.enableDamping=!0,this.controls.dampingFactor=.05,this.controls.enableZoom=!0,this.controls.enablePan=!0,this.controls.enableRotate=!0,this.controls.maxPolarAngle=Math.PI,this.controls.minDistance=2,this.controls.maxDistance=200,this.controls.autoRotate=!1,this.controls.autoRotateSpeed=.5,this.controls.target.set(0,-3,0),this.controls.update(),console.log("[SimpleMine3DViewer] OrbitControls initialized:",this.controls),console.log("[SimpleMine3DViewer] Initializing path drawer..."),this.pathDrawer=new rt(this.scene,this.camera,this.renderer),this.setupPathDrawingEvents(),console.log("[SimpleMine3DViewer] Initializing object creator..."),this.objectCreator=new at(this.scene,this.camera,this.renderer,this),console.log("[SimpleMine3DViewer] Initializing transform controls..."),this.transformControls=new Ke(this.camera,this.renderer.domElement),this.transformControls.addEventListener("change",()=>this.renderer.render(this.scene,this.camera)),this.transformControls.addEventListener("dragging-changed",n=>{this.controls.enabled=!n.value}),this.scene.add(this.transformControls),setTimeout(()=>{this.setupMiningControls()},100),console.log("[SimpleMine3DViewer] Initializing object selector..."),this.objectSelector=new lt(this.scene,this.camera,this.renderer),this.setupObjectSelection(),console.log("[SimpleMine3DViewer] Loading mine data..."),await this.loadMineData(),console.log("[SimpleMine3DViewer] Starting render loop..."),this.animate(),console.log("%c[SimpleMine3DViewer] Initialization completed successfully!","color: green; font-weight: bold; font-size: 14px;");const o=document.getElementById("loading-container");o&&o.style.display!=="none"&&(console.log("[SimpleMine3DViewer] Forcing loading container hide at end"),o.remove())}catch(e){throw console.error("%c[SimpleMine3DViewer] Initialization failed:","color: red; font-weight: bold;",{message:e.message,stack:e.stack,name:e.name}),e}}addLights(){console.log("[SimpleMine3DViewer] Adding shadowless lights to scene...");const e=new Ze(4210752,.6);this.scene.add(e),console.log("[SimpleMine3DViewer] Ambient light added:",e);const t=new $e(16777215,.9);t.position.set(50,50,50),t.castShadow=!1,this.scene.add(t),console.log("[SimpleMine3DViewer] Directional light added (shadowless):",t);const i=new qe(8900331,9127187,.5);i.position.set(0,20,0),this.scene.add(i),console.log("[SimpleMine3DViewer] Hemisphere light added:",i),[{pos:[10,2,10],color:16768324,intensity:.4},{pos:[-10,2,10],color:16768324,intensity:.4},{pos:[10,2,-10],color:16768324,intensity:.4},{pos:[-10,2,-10],color:16768324,intensity:.4}].forEach((o,n)=>{const a=new Ne(o.color,o.intensity,25);a.position.set(...o.pos),a.castShadow=!1,this.scene.add(a)}),console.log("[SimpleMine3DViewer] Mining lights added successfully")}setupMiningControls(){console.log("[SimpleMine3DViewer] Setting up mining controls...");const e=document.querySelectorAll(".mining-tool-btn");console.log("[SimpleMine3DViewer] Found tool buttons:",e.length,e),e.forEach(l=>{const p=l.getAttribute("data-tool");console.log("[SimpleMine3DViewer] Setting up button for tool:",p),l.addEventListener("click",w=>{w.preventDefault(),console.log(`🛠️ Mining tool butonuna tıklandı: ${p}`),this.startMiningTool(p)})});const t=document.getElementById("axis-x-btn"),i=document.getElementById("axis-y-btn"),s=document.getElementById("axis-z-btn"),o=document.getElementById("free-draw-btn");t&&t.addEventListener("click",()=>this.setDrawingConstraint("x")),i&&i.addEventListener("click",()=>this.setDrawingConstraint("y")),s&&s.addEventListener("click",()=>this.setDrawingConstraint("z")),o&&o.addEventListener("click",()=>this.setDrawingConstraint("free"));const n=document.getElementById("reset-camera-btn"),a=document.getElementById("toggle-grid-btn");n&&n.addEventListener("click",()=>{this.camera.position.set(15,5,25),this.camera.lookAt(0,-2,0),this.controls.target.set(0,-3,0),this.controls.update()}),a&&a.addEventListener("click",()=>{const l=this.scene.getObjectByName("grid_helper");l&&(l.visible=!l.visible)}),console.log("[SimpleMine3DViewer] Mining controls setup completed")}startMiningTool(e){console.log("🚀 [SimpleMine3DViewer] Starting mining tool:",e),this.isPathDrawingMode&&(console.log("🛑 Mevcut çizim modu durduruluyor..."),this.stopPathDrawing()),this.isCreatingMode&&(console.log("� Mevcut oluşturma modu durduruluyor..."),this.stopCreating()),console.log("🔧 Object creation mode başlatılıyor:",e),this.isCreatingMode=!0,this.controls.enabled=!1,this.objectCreator.startCreating(e),console.log("� Button states güncelleniyor..."),this.updateToolButtonStates(e),console.log("🎉 Mining tool başlatma işlemi tamamlandı:",e)}stopCreating(){this.isCreatingMode&&(this.isCreatingMode=!1,this.controls.enabled=!0,this.objectCreator.stopCreating(),this.updateToolButtonStates(null),console.log("[SimpleMine3DViewer] Creating mode stopped"))}updateToolIndicator(e){const t=document.getElementById("tool-indicator"),i=document.getElementById("tool-name");if(t&&i){const o={tunnel:{icon:"fas fa-mountain",name:"Tünel Kazma"},road:{icon:"fas fa-road",name:"Yol İnşaası"},rail:{icon:"fas fa-train",name:"Ray Döşeme"},conveyor:{icon:"fas fa-conveyor-belt",name:"Konveyör Kurma"}}[e]||{icon:"fas fa-tools",name:"Bilinmeyen Araç"};t.querySelector("i").className=o.icon+" me-2",i.textContent=o.name,t.style.display="block"}}updateToolButtonStates(e){document.querySelectorAll(".mining-tool-btn").forEach(i=>{const s=i.getAttribute("data-tool");s===e?(i.classList.remove("btn-outline-warning","btn-outline-info","btn-outline-success","btn-outline-danger"),i.classList.add("btn-warning")):(i.classList.remove("btn-warning","btn-info","btn-success","btn-danger"),i.classList.add(`btn-outline-${this.getToolColor(s)}`))})}getToolColor(e){return{tunnel:"warning",road:"info",rail:"success",conveyor:"danger"}[e]||"secondary"}setDrawingConstraint(e){console.log("[SimpleMine3DViewer] Setting drawing constraint to:",e),this.activeConstraint=e,document.querySelectorAll("#axis-x-btn, #axis-y-btn, #axis-z-btn, #free-draw-btn").forEach(s=>{s.classList.remove("btn-light","btn-outline-light"),s.classList.add("btn-outline-light")});let i=null;switch(e){case"x":i=document.getElementById("axis-x-btn");break;case"y":i=document.getElementById("axis-y-btn");break;case"z":i=document.getElementById("axis-z-btn");break;case"free":i=document.getElementById("free-draw-btn");break}i&&(i.classList.remove("btn-outline-light"),i.classList.add("btn-light")),this.pathDrawer&&this.pathDrawer.setAxisConstraint(e),console.log("[SimpleMine3DViewer] Constraint set to:",e)}addTestGeometry(){console.log("[SimpleMine3DViewer] Adding test geometry...");try{console.log("[SimpleMine3DViewer] Creating infinite ground plane...");const e=1e3,t=new me(e,e,50,50),i=new le({color:5668166,transparent:!1}),s=new r(t,i);s.rotation.x=-Math.PI/2,s.position.y=-5,s.receiveShadow=!0,s.name="ground_plane",this.scene.add(s),console.log("[SimpleMine3DViewer] Infinite ground plane added:",s);const o=new We(e,100,8947848,4473924);o.position.y=-4.9,o.material.opacity=.3,o.material.transparent=!0,this.scene.add(o);const n=new me(e,e),a=new le({color:9127187,transparent:!0,opacity:.8}),l=new r(n,a);l.rotation.x=-Math.PI/2,l.position.y=-10,l.receiveShadow=!0,l.name="underground_layer",this.scene.add(l),console.log("[SimpleMine3DViewer] Test geometry added successfully"),console.log("[SimpleMine3DViewer] Scene children count:",this.scene.children.length)}catch(e){throw console.error("[SimpleMine3DViewer] Error adding test geometry:",e),e}}async loadMineData(){console.log("[SimpleMine3DViewer] Loading mine data for mine ID:",this.mineId);try{const e=`/api/mines/${this.mineId}/scene-data`;console.log("[SimpleMine3DViewer] Fetching from URL:",e);const t=await fetch(e);if(console.log("[SimpleMine3DViewer] Fetch response:",{ok:t.ok,status:t.status,statusText:t.statusText,headers:Object.fromEntries(t.headers.entries())}),!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);const i=await t.json();console.log("[SimpleMine3DViewer] Mine data loaded successfully:",i),i&&i.models&&console.log("[SimpleMine3DViewer] Processing",i.models.length,"models"),i&&i.layers&&console.log("[SimpleMine3DViewer] Processing",i.layers.length,"layers"),i&&i.paths&&(console.log("[SimpleMine3DViewer] Processing",i.paths.length,"paths"),this.loadPaths(i.paths))}catch(e){console.warn("[SimpleMine3DViewer] Could not load mine data:",{message:e.message,stack:e.stack}),console.log("[SimpleMine3DViewer] Continuing with test geometry only")}}loadPaths(e){console.log("[SimpleMine3DViewer] Loading paths:",e),e.forEach(t=>{if(t.path_points&&t.path_points.length>1){const i=t.path_points.map(o=>new c(o.x,o.y,o.z)),s=this.pathDrawer.createPath({id:t.id,points:i,width:t.width||3,height:t.height||3,color:t.color||"#808080",type:t.type||"tunnel"});s&&this.objectSelector&&this.objectSelector.addSelectableObject(s,{id:t.id,type:"path",name:t.name,pathType:t.type,width:t.width,height:t.height,color:t.color,material:t.material,points:t.path_points,length:this.pathDrawer.calculatePathLength(t.path_points)})}})}animate(){const e=performance.now();requestAnimationFrame(()=>this.animate());try{this.controls&&this.controls.update(),this.renderer&&this.scene&&this.camera?this.renderer.render(this.scene,this.camera):console.error("[SimpleMine3DViewer] Missing components for rendering:",{renderer:!!this.renderer,scene:!!this.scene,camera:!!this.camera})}catch(s){console.error("[SimpleMine3DViewer] Render error:",s)}const i=performance.now()-e;this.frameCount||(this.frameCount=0),this.frameCount++,this.frameCount%60===0&&console.log(`[SimpleMine3DViewer] Performance - Frame ${this.frameCount}, Frame time: ${i.toFixed(2)}ms`)}destroy(){this.renderer&&(this.container.removeChild(this.renderer.domElement),this.renderer.dispose())}setupPathDrawingEvents(){const e=this.renderer.domElement;this.boundHandlers={click:t=>this.handleCanvasClick(t),mousemove:t=>this.handleCanvasMouseMove(t),keydown:t=>this.handleKeyDown(t)},e.addEventListener("click",this.boundHandlers.click),e.addEventListener("mousemove",this.boundHandlers.mousemove),document.addEventListener("keydown",this.boundHandlers.keydown)}handleCanvasClick(e){e.preventDefault(),e.stopPropagation(),this.isPathDrawingMode?this.pathDrawer.handleClick(e):this.isCreatingMode?this.updateCreationPosition(e):this.handleObjectSelection(e)}updateCreationPosition(e){const t=this.renderer.domElement.getBoundingClientRect(),i=new ce;i.x=(e.clientX-t.left)/t.width*2-1,i.y=-((e.clientY-t.top)/t.height)*2+1;const s=new W;s.setFromCamera(i,this.camera);const o=new Pe(new c(0,1,0),-2),n=new c;s.ray.intersectPlane(o,n)&&(this.objectCreator.currentPosition.copy(n),this.objectCreator.createPreview(),console.log("[SimpleMine3DViewer] Updated creation position:",n))}handleObjectSelection(e){const t=this.renderer.domElement.getBoundingClientRect(),i=new ce;i.x=(e.clientX-t.left)/t.width*2-1,i.y=-((e.clientY-t.top)/t.height)*2+1;const s=new W;s.setFromCamera(i,this.camera);const o=[];this.scene.traverse(a=>{a.userData&&a.userData.selectable&&a.isMesh&&o.push(a)});const n=s.intersectObjects(o);if(n.length>0){const a=n[0].object;this.selectObject(a)}else this.deselectObject()}selectObject(e){this.selectedObject&&this.deselectObject(),this.selectedObject=e,this.transformControls.attach(e),this.addHighlight(e),console.log("[SimpleMine3DViewer] Object selected:",e.userData)}deselectObject(){this.selectedObject&&(this.transformControls.detach(),this.removeHighlight(this.selectedObject),this.selectedObject=null,console.log("[SimpleMine3DViewer] Object deselected")),this.objectCreator&&this.objectCreator.removePreview()}addHighlight(e){e.userData.originalMaterial||(e.userData.originalMaterial=e.material,e.material=e.material.clone(),e.material.emissive.setHex(4473924))}removeHighlight(e){e.userData.originalMaterial&&(e.material.dispose(),e.material=e.userData.originalMaterial,delete e.userData.originalMaterial)}handleCanvasMouseMove(e){this.isPathDrawingMode&&this.pathDrawer.handleMouseMove(e)}handleKeyDown(e){console.log("[SimpleMine3DViewer] Key pressed:",e.key),e.key==="Escape"?(e.preventDefault(),this.isPathDrawingMode?(this.pathDrawer.stopDrawing(),this.stopPathDrawing()):this.isCreatingMode?this.stopCreating():this.selectedObject&&this.deselectObject()):e.key==="Enter"&&this.isPathDrawingMode?(e.preventDefault(),this.completeCurrentPath()):e.key==="Delete"||e.key==="Backspace"?(e.preventDefault(),this.selectedObject?this.deleteSelectedObject():console.log("[SimpleMine3DViewer] No object selected for deletion")):(e.key==="g"||e.key==="G")&&(e.preventDefault(),this.selectedObject&&this.transformControls.object&&this.cycleTransformMode())}cycleTransformMode(){const e=this.transformControls.getMode(),t=["translate","rotate","scale"],i=t.indexOf(e),s=t[(i+1)%t.length];this.transformControls.setMode(s),console.log("[SimpleMine3DViewer] Transform mode changed to:",s)}async saveObjectToServer(e){var t,i;try{const s={mine_id:this.mineId,name:`${e.userData.type.charAt(0).toUpperCase()+e.userData.type.slice(1)} ${e.userData.id}`,type:e.userData.type,geometry:{type:e.userData.type,...e.userData.parameters},material:{color:e.material.color.getHex(),opacity:e.material.opacity||1},position:[e.position.x,e.position.y,e.position.z],rotation:[e.rotation.x,e.rotation.y,e.rotation.z],scale:[e.scale.x,e.scale.y,e.scale.z],properties:{createdAt:new Date().toISOString(),tool:e.userData.type},visible:!0,order:e.userData.id},o=await fetch(`/api/mines/${this.mineId}/models`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":((t=document.querySelector('meta[name="csrf-token"]'))==null?void 0:t.getAttribute("content"))||"",Accept:"application/json"},body:JSON.stringify(s)});if(o.ok){const n=await o.json();e.userData.serverId=(i=n.data)==null?void 0:i.id,console.log("[SimpleMine3DViewer] Successfully saved object to server:",n),this.showSuccess("Obje başarıyla kaydedildi!")}else throw new Error(`HTTP ${o.status}: ${o.statusText}`)}catch(s){console.error("[SimpleMine3DViewer] Error saving object to server:",s),this.showError("Obje kaydedilemedi: "+s.message)}}showSuccess(e){const t=document.createElement("div");t.style.cssText=`
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #44aa44;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 10000;
        `,t.textContent=e,document.body.appendChild(t),setTimeout(()=>{t.parentNode&&document.body.removeChild(t)},3e3)}showError(e){const t=document.createElement("div");t.style.cssText=`
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #ff4444;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 10000;
        `,t.textContent=e,document.body.appendChild(t),setTimeout(()=>{t.parentNode&&document.body.removeChild(t)},3e3)}deleteSelectedObject(){if(this.selectedObject){const e=this.selectedObject;this.transformControls.detach(),this.scene.remove(e),e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose(),this.objectCreator.createdObjects.has(e.userData.id)&&this.objectCreator.createdObjects.delete(e.userData.id),this.selectedObject=null,console.log("[SimpleMine3DViewer] Object deleted:",e.userData),e.userData.serverId&&this.deleteFromServer(e.userData.serverId)}}async deleteFromServer(e){var t;try{const i=await fetch(`/api/mines/${this.mineId}/models/${e}`,{method:"DELETE",headers:{"X-CSRF-TOKEN":((t=document.querySelector('meta[name="csrf-token"]'))==null?void 0:t.getAttribute("content"))||"",Accept:"application/json"}});if(i.ok)console.log("[SimpleMine3DViewer] Successfully deleted from server"),this.showSuccess("Obje başarıyla silindi!");else throw new Error(`HTTP ${i.status}: ${i.statusText}`)}catch(i){console.error("[SimpleMine3DViewer] Error deleting from server:",i),this.showError("Obje silinemedi: "+i.message)}}setupObjectSelection(){this.objectSelector.setCallbacks({onObjectSelect:(e,t)=>this.onObjectSelected(e,t),onObjectDeselect:e=>this.onObjectDeselected(e),onObjectDelete:e=>this.onObjectDelete(e)})}onObjectSelected(e,t){console.log("[SimpleMine3DViewer] Object selected:",t),this.selectedObject=e,this.showObjectInfo(t)}onObjectDeselected(e){console.log("[SimpleMine3DViewer] Object deselected"),this.selectedObject=null,this.hideObjectInfo()}async onObjectDelete(e){var i;console.log("[SimpleMine3DViewer] Deleting object:",e.userData.objectData);const t=e.userData.objectData;if(t&&t.id&&t.type==="path")try{const s=await fetch(`/api/mines/${this.mineId}/paths/${t.id}`,{method:"DELETE",headers:{"X-CSRF-TOKEN":((i=document.querySelector('meta[name="csrf-token"]'))==null?void 0:i.getAttribute("content"))||"",Accept:"application/json"}});if(s.ok)this.pathDrawer.removePath(t.id),this.objectSelector.removeSelectableObject(e),console.log("[SimpleMine3DViewer] Path deleted successfully");else throw new Error(`HTTP ${s.status}: ${s.statusText}`)}catch(s){console.error("[SimpleMine3DViewer] Error deleting path:",s),this.showError("Yol silinemedi: "+s.message)}}startPathDrawing(){this.isPathDrawingMode=!0,this.controls.enabled=!1,this.pathDrawer.startDrawing({onPathStart:()=>console.log("[SimpleMine3DViewer] Yol çizimi başladı"),onPathUpdate:e=>console.log("[SimpleMine3DViewer] Yol güncellendi, nokta sayısı:",e.length),onPathComplete:e=>this.onPathDrawingComplete(e)}),this.showPathDrawingUI(!0),console.log("[SimpleMine3DViewer] Yol çizim modu aktif")}stopPathDrawing(){this.isPathDrawingMode=!1,this.controls.enabled=!0,this.pathDrawer.stopDrawing(),this.showPathDrawingUI(!1),console.log("[SimpleMine3DViewer] Yol çizim modu pasif")}completeCurrentPath(){if(this.isPathDrawingMode){console.log("[SimpleMine3DViewer] Manual path completion");const e=this.pathDrawer.completePath();e&&e.length>1&&(this.onPathDrawingComplete(e),this.stopPathDrawing())}}onPathDrawingComplete(e){console.log("[SimpleMine3DViewer] Yol çizimi tamamlandı:",e),this.savePathToServer(e).then(t=>{if(t){const i=this.pathDrawer.createPath({id:t.id,points:e,width:t.width||2.5,height:t.height||2.5,color:t.color||"#808080",type:t.type||"tunnel"});i&&this.objectSelector&&this.objectSelector.addSelectableObject(i,{id:t.id,type:"path",name:t.name,pathType:t.type,width:t.width,height:t.height,color:t.color,material:t.material,points:e.map(s=>({x:s.x,y:s.y,z:s.z})),length:this.pathDrawer.calculatePathLength(e.map(s=>({x:s.x,y:s.y,z:s.z})))})}}).catch(t=>{console.error("[SimpleMine3DViewer] Yol kaydetme hatası:",t),this.showError("Yol kaydedilemedi: "+t.message)})}async savePathToServer(e){var t;try{const i={mine_id:this.mineId,name:`Yol ${Date.now()}`,type:"tunnel",path_points:e.map(a=>({x:a.x,y:a.y,z:a.z})),width:2.5,height:2.5,color:"#808080",status:"active"},s=await fetch(`/api/mines/${this.mineId}/paths`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":((t=document.querySelector('meta[name="csrf-token"]'))==null?void 0:t.getAttribute("content"))||"",Accept:"application/json"},body:JSON.stringify(i)});if(!s.ok){const a=await s.json().catch(()=>({}));throw new Error(a.message||`HTTP ${s.status}: ${s.statusText}`)}const o=await s.json(),n=o.data||o;return console.log("[SimpleMine3DViewer] Yol başarıyla kaydedildi:",n),n}catch(i){throw console.error("[SimpleMine3DViewer] Yol kaydetme hatası:",i),i}}showPathDrawingUI(e){console.log("[SimpleMine3DViewer] Path drawing UI:",e?"show":"hide");const t=document.getElementById("path-controls"),i=document.getElementById("draw-path-btn"),s=document.getElementById("path-btn-text");e?(t&&(t.style.display="block"),s&&(s.textContent="Çizimi Bitir"),i&&(i.classList.remove("btn-outline-warning"),i.classList.add("btn-warning"))):(t&&(t.style.display="none"),s&&(s.textContent="Yol Çiz"),i&&(i.classList.remove("btn-warning"),i.classList.add("btn-outline-warning")));const o=document.getElementById("path-drawing-overlay");if(e&&!o){const n=document.createElement("div");n.id="path-drawing-overlay",n.innerHTML=`
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                           background: rgba(0,0,0,0.8); color: white; padding: 20px; border-radius: 10px;
                           text-align: center; z-index: 1000;">
                    <h5>Yol Çizim Modu</h5>
                    <p>Yol noktalarını tıklayarak belirleyin</p>
                    <small>Enter: Tamamla | Escape: İptal</small>
                </div>
            `,this.container.appendChild(n)}else!e&&o&&o.remove()}showError(e){const t=document.getElementById("error-content");t?(t.textContent=e,new bootstrap.Modal(document.getElementById("errorModal")).show()):alert(e)}showObjectInfo(e){const t=document.getElementById("object-info-panel"),i=document.getElementById("object-info-content");if(t&&i){let s=`
                <h6 class="mb-2">${e.name||"Seçili Obje"}</h6>
                <div class="mb-2">
                    <small class="text-muted">Tip:</small><br>
                    <span class="badge bg-primary">${this.getTypeDisplayName(e.pathType)}</span>
                </div>
            `;if(e.type==="path"){s+=`
                    <div class="mb-2">
                        <small class="text-muted">Fiziksel Özellikler:</small><br>
                        <div class="row">
                            <div class="col-6"><small>Genişlik: ${e.width}m</small></div>
                            <div class="col-6"><small>Yükseklik: ${e.height}m</small></div>
                        </div>
                        <small>Uzunluk: ${e.length.toFixed(2)}m</small><br>
                        <small>Malzeme: ${e.material||"N/A"}</small>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">Renk:</small><br>
                        <span class="badge" style="background-color: ${e.color}; color: white;">${e.color}</span>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">Nokta Sayısı:</small><br>
                        <span>${e.points.length} nokta</span>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">Segmentler:</small><br>
                `;for(let o=1;o<e.points.length;o++){const n=e.points[o-1],a=e.points[o],l=a.x-n.x,p=a.y-n.y,w=a.z-n.z,d=Math.sqrt(l*l+p*p+w*w);s+=`<small>Segment ${o}: ${d.toFixed(2)}m</small><br>`}s+=`
                    </div>
                    <div class="d-grid gap-1">
                        <button class="btn btn-outline-warning btn-sm" onclick="window.mineViewer.editSelectedObject()">
                            <i class="fas fa-edit"></i> Düzenle
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="window.mineViewer.deleteSelectedObject()">
                            <i class="fas fa-trash"></i> Sil
                        </button>
                    </div>
                `}i.innerHTML=s,t.style.display="block"}}hideObjectInfo(){const e=document.getElementById("object-info-panel");e&&(e.style.display="none")}getTypeDisplayName(e){return{tunnel:"Tünel",road:"Yol",rail:"Ray",conveyor:"Konveyör"}[e]||e}editSelectedObject(){if(this.selectedObject){const e=this.selectedObject.userData.objectData;console.log("[SimpleMine3DViewer] Editing object:",e),alert("Düzenleme özelliği yakında gelecek!")}}deleteSelectedObject(){this.selectedObject&&confirm("Bu objeyi silmek istediğinizden emin misiniz?")&&this.objectSelector.deleteSelectedObject()}}window.SimpleMine3DViewer=ct;
