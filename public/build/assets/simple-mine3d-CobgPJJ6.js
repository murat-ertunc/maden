import{R as U,l as m,m as we,Q as F,n as Y,L as N,f as T,g as k,B as se,e as De,M as u,o as ce,p as A,q as _e,r as K,s as be,j as je,E as Ge,t as ze,u as Ye,S as Re,C as ve,P as Xe,W as $e,v as Ne,b as Qe,O as qe,w as ge,x as xe,A as Ze,D as Ue,H as We,y as Ke,z as pe,G as Je,V as ne,k as Me,i as Be,I as et,J as tt,K as it,N as $,U as Ae,X as Le,Y as q,Z}from"./OrbitControls-Dwqi_uo-.js";const R=new U,I=new m,G=new m,E=new F,Ee={X:new m(1,0,0),Y:new m(0,1,0),Z:new m(0,0,1)},ye={type:"change"},Pe={type:"mouseDown"},Ce={type:"mouseUp",mode:null},Oe={type:"objectChange"};class st extends we{constructor(e,t){super(),t===void 0&&(console.warn('THREE.TransformControls: The second parameter "domElement" is now mandatory.'),t=document),this.isTransformControls=!0,this.visible=!1,this.domElement=t,this.domElement.style.touchAction="none";const i=new ct;this._gizmo=i,this.add(i);const s=new ht;this._plane=s,this.add(s);const a=this;function n(v,P){let O=P;Object.defineProperty(a,v,{get:function(){return O!==void 0?O:P},set:function(g){O!==g&&(O=g,s[v]=g,i[v]=g,a.dispatchEvent({type:v+"-changed",value:g}),a.dispatchEvent(ye))}}),a[v]=P,s[v]=P,i[v]=P}n("camera",e),n("object",void 0),n("enabled",!0),n("axis",null),n("mode","translate"),n("translationSnap",null),n("rotationSnap",null),n("scaleSnap",null),n("space","world"),n("size",1),n("dragging",!1),n("showX",!0),n("showY",!0),n("showZ",!0);const o=new m,c=new m,h=new F,l=new F,d=new m,r=new F,f=new m,p=new m,w=new m,b=0,M=new m;n("worldPosition",o),n("worldPositionStart",c),n("worldQuaternion",h),n("worldQuaternionStart",l),n("cameraPosition",d),n("cameraQuaternion",r),n("pointStart",f),n("pointEnd",p),n("rotationAxis",w),n("rotationAngle",b),n("eye",M),this._offset=new m,this._startNorm=new m,this._endNorm=new m,this._cameraScale=new m,this._parentPosition=new m,this._parentQuaternion=new F,this._parentQuaternionInv=new F,this._parentScale=new m,this._worldScaleStart=new m,this._worldQuaternionInv=new F,this._worldScale=new m,this._positionStart=new m,this._quaternionStart=new F,this._scaleStart=new m,this._getPointer=nt.bind(this),this._onPointerDown=ot.bind(this),this._onPointerHover=at.bind(this),this._onPointerMove=rt.bind(this),this._onPointerUp=lt.bind(this),this.domElement.addEventListener("pointerdown",this._onPointerDown),this.domElement.addEventListener("pointermove",this._onPointerHover),this.domElement.addEventListener("pointerup",this._onPointerUp)}updateMatrixWorld(){this.object!==void 0&&(this.object.updateMatrixWorld(),this.object.parent===null?console.error("TransformControls: The attached 3D object must be a part of the scene graph."):this.object.parent.matrixWorld.decompose(this._parentPosition,this._parentQuaternion,this._parentScale),this.object.matrixWorld.decompose(this.worldPosition,this.worldQuaternion,this._worldScale),this._parentQuaternionInv.copy(this._parentQuaternion).invert(),this._worldQuaternionInv.copy(this.worldQuaternion).invert()),this.camera.updateMatrixWorld(),this.camera.matrixWorld.decompose(this.cameraPosition,this.cameraQuaternion,this._cameraScale),this.camera.isOrthographicCamera?this.camera.getWorldDirection(this.eye).negate():this.eye.copy(this.cameraPosition).sub(this.worldPosition).normalize(),super.updateMatrixWorld(this)}pointerHover(e){if(this.object===void 0||this.dragging===!0)return;R.setFromCamera(e,this.camera);const t=fe(this._gizmo.picker[this.mode],R);t?this.axis=t.object.name:this.axis=null}pointerDown(e){if(!(this.object===void 0||this.dragging===!0||e.button!==0)&&this.axis!==null){R.setFromCamera(e,this.camera);const t=fe(this._plane,R,!0);t&&(this.object.updateMatrixWorld(),this.object.parent.updateMatrixWorld(),this._positionStart.copy(this.object.position),this._quaternionStart.copy(this.object.quaternion),this._scaleStart.copy(this.object.scale),this.object.matrixWorld.decompose(this.worldPositionStart,this.worldQuaternionStart,this._worldScaleStart),this.pointStart.copy(t.point).sub(this.worldPositionStart)),this.dragging=!0,Pe.mode=this.mode,this.dispatchEvent(Pe)}}pointerMove(e){const t=this.axis,i=this.mode,s=this.object;let a=this.space;if(i==="scale"?a="local":(t==="E"||t==="XYZE"||t==="XYZ")&&(a="world"),s===void 0||t===null||this.dragging===!1||e.button!==-1)return;R.setFromCamera(e,this.camera);const n=fe(this._plane,R,!0);if(n){if(this.pointEnd.copy(n.point).sub(this.worldPositionStart),i==="translate")this._offset.copy(this.pointEnd).sub(this.pointStart),a==="local"&&t!=="XYZ"&&this._offset.applyQuaternion(this._worldQuaternionInv),t.indexOf("X")===-1&&(this._offset.x=0),t.indexOf("Y")===-1&&(this._offset.y=0),t.indexOf("Z")===-1&&(this._offset.z=0),a==="local"&&t!=="XYZ"?this._offset.applyQuaternion(this._quaternionStart).divide(this._parentScale):this._offset.applyQuaternion(this._parentQuaternionInv).divide(this._parentScale),s.position.copy(this._offset).add(this._positionStart),this.translationSnap&&(a==="local"&&(s.position.applyQuaternion(E.copy(this._quaternionStart).invert()),t.search("X")!==-1&&(s.position.x=Math.round(s.position.x/this.translationSnap)*this.translationSnap),t.search("Y")!==-1&&(s.position.y=Math.round(s.position.y/this.translationSnap)*this.translationSnap),t.search("Z")!==-1&&(s.position.z=Math.round(s.position.z/this.translationSnap)*this.translationSnap),s.position.applyQuaternion(this._quaternionStart)),a==="world"&&(s.parent&&s.position.add(I.setFromMatrixPosition(s.parent.matrixWorld)),t.search("X")!==-1&&(s.position.x=Math.round(s.position.x/this.translationSnap)*this.translationSnap),t.search("Y")!==-1&&(s.position.y=Math.round(s.position.y/this.translationSnap)*this.translationSnap),t.search("Z")!==-1&&(s.position.z=Math.round(s.position.z/this.translationSnap)*this.translationSnap),s.parent&&s.position.sub(I.setFromMatrixPosition(s.parent.matrixWorld))));else if(i==="scale"){if(t.search("XYZ")!==-1){let o=this.pointEnd.length()/this.pointStart.length();this.pointEnd.dot(this.pointStart)<0&&(o*=-1),G.set(o,o,o)}else I.copy(this.pointStart),G.copy(this.pointEnd),I.applyQuaternion(this._worldQuaternionInv),G.applyQuaternion(this._worldQuaternionInv),G.divide(I),t.search("X")===-1&&(G.x=1),t.search("Y")===-1&&(G.y=1),t.search("Z")===-1&&(G.z=1);s.scale.copy(this._scaleStart).multiply(G),this.scaleSnap&&(t.search("X")!==-1&&(s.scale.x=Math.round(s.scale.x/this.scaleSnap)*this.scaleSnap||this.scaleSnap),t.search("Y")!==-1&&(s.scale.y=Math.round(s.scale.y/this.scaleSnap)*this.scaleSnap||this.scaleSnap),t.search("Z")!==-1&&(s.scale.z=Math.round(s.scale.z/this.scaleSnap)*this.scaleSnap||this.scaleSnap))}else if(i==="rotate"){this._offset.copy(this.pointEnd).sub(this.pointStart);const o=20/this.worldPosition.distanceTo(I.setFromMatrixPosition(this.camera.matrixWorld));let c=!1;t==="XYZE"?(this.rotationAxis.copy(this._offset).cross(this.eye).normalize(),this.rotationAngle=this._offset.dot(I.copy(this.rotationAxis).cross(this.eye))*o):(t==="X"||t==="Y"||t==="Z")&&(this.rotationAxis.copy(Ee[t]),I.copy(Ee[t]),a==="local"&&I.applyQuaternion(this.worldQuaternion),I.cross(this.eye),I.length()===0?c=!0:this.rotationAngle=this._offset.dot(I.normalize())*o),(t==="E"||c)&&(this.rotationAxis.copy(this.eye),this.rotationAngle=this.pointEnd.angleTo(this.pointStart),this._startNorm.copy(this.pointStart).normalize(),this._endNorm.copy(this.pointEnd).normalize(),this.rotationAngle*=this._endNorm.cross(this._startNorm).dot(this.eye)<0?1:-1),this.rotationSnap&&(this.rotationAngle=Math.round(this.rotationAngle/this.rotationSnap)*this.rotationSnap),a==="local"&&t!=="E"&&t!=="XYZE"?(s.quaternion.copy(this._quaternionStart),s.quaternion.multiply(E.setFromAxisAngle(this.rotationAxis,this.rotationAngle)).normalize()):(this.rotationAxis.applyQuaternion(this._parentQuaternionInv),s.quaternion.copy(E.setFromAxisAngle(this.rotationAxis,this.rotationAngle)),s.quaternion.multiply(this._quaternionStart).normalize())}this.dispatchEvent(ye),this.dispatchEvent(Oe)}}pointerUp(e){e.button===0&&(this.dragging&&this.axis!==null&&(Ce.mode=this.mode,this.dispatchEvent(Ce)),this.dragging=!1,this.axis=null)}dispose(){this.domElement.removeEventListener("pointerdown",this._onPointerDown),this.domElement.removeEventListener("pointermove",this._onPointerHover),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.traverse(function(e){e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose()})}attach(e){return this.object=e,this.visible=!0,this}detach(){return this.object=void 0,this.visible=!1,this.axis=null,this}reset(){this.enabled&&this.dragging&&(this.object.position.copy(this._positionStart),this.object.quaternion.copy(this._quaternionStart),this.object.scale.copy(this._scaleStart),this.dispatchEvent(ye),this.dispatchEvent(Oe),this.pointStart.copy(this.pointEnd))}getRaycaster(){return R}getMode(){return this.mode}setMode(e){this.mode=e}setTranslationSnap(e){this.translationSnap=e}setRotationSnap(e){this.rotationSnap=e}setScaleSnap(e){this.scaleSnap=e}setSize(e){this.size=e}setSpace(e){this.space=e}}function nt(y){if(this.domElement.ownerDocument.pointerLockElement)return{x:0,y:0,button:y.button};{const e=this.domElement.getBoundingClientRect();return{x:(y.clientX-e.left)/e.width*2-1,y:-(y.clientY-e.top)/e.height*2+1,button:y.button}}}function at(y){if(this.enabled)switch(y.pointerType){case"mouse":case"pen":this.pointerHover(this._getPointer(y));break}}function ot(y){this.enabled&&(document.pointerLockElement||this.domElement.setPointerCapture(y.pointerId),this.domElement.addEventListener("pointermove",this._onPointerMove),this.pointerHover(this._getPointer(y)),this.pointerDown(this._getPointer(y)))}function rt(y){this.enabled&&this.pointerMove(this._getPointer(y))}function lt(y){this.enabled&&(this.domElement.releasePointerCapture(y.pointerId),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.pointerUp(this._getPointer(y)))}function fe(y,e,t){const i=e.intersectObject(y,!0);for(let s=0;s<i.length;s++)if(i[s].object.visible||t)return i[s];return!1}const he=new Ge,S=new m(0,1,0),ke=new m(0,0,0),Te=new ze,de=new F,me=new F,H=new m,Ie=new ze,te=new m(1,0,0),X=new m(0,1,0),ie=new m(0,0,1),ue=new m,J=new m,ee=new m;class ct extends we{constructor(){super(),this.isTransformControlsGizmo=!0,this.type="TransformControlsGizmo";const e=new Y({depthTest:!1,depthWrite:!1,fog:!1,toneMapped:!1,transparent:!0}),t=new N({depthTest:!1,depthWrite:!1,fog:!1,toneMapped:!1,transparent:!0}),i=e.clone();i.opacity=.15;const s=t.clone();s.opacity=.5;const a=e.clone();a.color.setHex(16711680);const n=e.clone();n.color.setHex(65280);const o=e.clone();o.color.setHex(255);const c=e.clone();c.color.setHex(16711680),c.opacity=.5;const h=e.clone();h.color.setHex(65280),h.opacity=.5;const l=e.clone();l.color.setHex(255),l.opacity=.5;const d=e.clone();d.opacity=.25;const r=e.clone();r.color.setHex(16776960),r.opacity=.25,e.clone().color.setHex(16776960);const p=e.clone();p.color.setHex(7895160);const w=new T(0,.04,.1,12);w.translate(0,.05,0);const b=new k(.08,.08,.08);b.translate(0,.04,0);const M=new se;M.setAttribute("position",new De([0,0,0,1,0,0],3));const v=new T(.0075,.0075,.5,3);v.translate(0,.25,0);function P(z,ae){const B=new K(z,.0075,3,64,ae*Math.PI*2);return B.rotateY(Math.PI/2),B.rotateX(Math.PI/2),B}function O(){const z=new se;return z.setAttribute("position",new De([0,0,0,1,1,1],3)),z}const g={X:[[new u(w,a),[.5,0,0],[0,0,-Math.PI/2]],[new u(w,a),[-.5,0,0],[0,0,Math.PI/2]],[new u(v,a),[0,0,0],[0,0,-Math.PI/2]]],Y:[[new u(w,n),[0,.5,0]],[new u(w,n),[0,-.5,0],[Math.PI,0,0]],[new u(v,n)]],Z:[[new u(w,o),[0,0,.5],[Math.PI/2,0,0]],[new u(w,o),[0,0,-.5],[-Math.PI/2,0,0]],[new u(v,o),null,[Math.PI/2,0,0]]],XYZ:[[new u(new ce(.1,0),d.clone()),[0,0,0]]],XY:[[new u(new k(.15,.15,.01),l.clone()),[.15,.15,0]]],YZ:[[new u(new k(.15,.15,.01),c.clone()),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new u(new k(.15,.15,.01),h.clone()),[.15,0,.15],[-Math.PI/2,0,0]]]},D={X:[[new u(new T(.2,0,.6,4),i),[.3,0,0],[0,0,-Math.PI/2]],[new u(new T(.2,0,.6,4),i),[-.3,0,0],[0,0,Math.PI/2]]],Y:[[new u(new T(.2,0,.6,4),i),[0,.3,0]],[new u(new T(.2,0,.6,4),i),[0,-.3,0],[0,0,Math.PI]]],Z:[[new u(new T(.2,0,.6,4),i),[0,0,.3],[Math.PI/2,0,0]],[new u(new T(.2,0,.6,4),i),[0,0,-.3],[-Math.PI/2,0,0]]],XYZ:[[new u(new ce(.2,0),i)]],XY:[[new u(new k(.2,.2,.01),i),[.15,.15,0]]],YZ:[[new u(new k(.2,.2,.01),i),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new u(new k(.2,.2,.01),i),[.15,0,.15],[-Math.PI/2,0,0]]]},x={START:[[new u(new ce(.01,2),s),null,null,null,"helper"]],END:[[new u(new ce(.01,2),s),null,null,null,"helper"]],DELTA:[[new A(O(),s),null,null,null,"helper"]],X:[[new A(M,s.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new A(M,s.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new A(M,s.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},C={XYZE:[[new u(P(.5,1),p),null,[0,Math.PI/2,0]]],X:[[new u(P(.5,.5),a)]],Y:[[new u(P(.5,.5),n),null,[0,0,-Math.PI/2]]],Z:[[new u(P(.5,.5),o),null,[0,Math.PI/2,0]]],E:[[new u(P(.75,1),r),null,[0,Math.PI/2,0]]]},j={AXIS:[[new A(M,s.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]]},W={XYZE:[[new u(new _e(.25,10,8),i)]],X:[[new u(new K(.5,.1,4,24),i),[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new u(new K(.5,.1,4,24),i),[0,0,0],[Math.PI/2,0,0]]],Z:[[new u(new K(.5,.1,4,24),i),[0,0,0],[0,0,-Math.PI/2]]],E:[[new u(new K(.75,.1,2,24),i)]]},L={X:[[new u(b,a),[.5,0,0],[0,0,-Math.PI/2]],[new u(v,a),[0,0,0],[0,0,-Math.PI/2]],[new u(b,a),[-.5,0,0],[0,0,Math.PI/2]]],Y:[[new u(b,n),[0,.5,0]],[new u(v,n)],[new u(b,n),[0,-.5,0],[0,0,Math.PI]]],Z:[[new u(b,o),[0,0,.5],[Math.PI/2,0,0]],[new u(v,o),[0,0,0],[Math.PI/2,0,0]],[new u(b,o),[0,0,-.5],[-Math.PI/2,0,0]]],XY:[[new u(new k(.15,.15,.01),l),[.15,.15,0]]],YZ:[[new u(new k(.15,.15,.01),c),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new u(new k(.15,.15,.01),h),[.15,0,.15],[-Math.PI/2,0,0]]],XYZ:[[new u(new k(.1,.1,.1),d.clone())]]},He={X:[[new u(new T(.2,0,.6,4),i),[.3,0,0],[0,0,-Math.PI/2]],[new u(new T(.2,0,.6,4),i),[-.3,0,0],[0,0,Math.PI/2]]],Y:[[new u(new T(.2,0,.6,4),i),[0,.3,0]],[new u(new T(.2,0,.6,4),i),[0,-.3,0],[0,0,Math.PI]]],Z:[[new u(new T(.2,0,.6,4),i),[0,0,.3],[Math.PI/2,0,0]],[new u(new T(.2,0,.6,4),i),[0,0,-.3],[-Math.PI/2,0,0]]],XY:[[new u(new k(.2,.2,.01),i),[.15,.15,0]]],YZ:[[new u(new k(.2,.2,.01),i),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new u(new k(.2,.2,.01),i),[.15,0,.15],[-Math.PI/2,0,0]]],XYZ:[[new u(new k(.2,.2,.2),i),[0,0,0]]]},Fe={X:[[new A(M,s.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new A(M,s.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new A(M,s.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]};function V(z){const ae=new we;for(const B in z)for(let Q=z[B].length;Q--;){const _=z[B][Q][0].clone(),oe=z[B][Q][1],re=z[B][Q][2],le=z[B][Q][3],Ve=z[B][Q][4];_.name=B,_.tag=Ve,oe&&_.position.set(oe[0],oe[1],oe[2]),re&&_.rotation.set(re[0],re[1],re[2]),le&&_.scale.set(le[0],le[1],le[2]),_.updateMatrix();const Se=_.geometry.clone();Se.applyMatrix4(_.matrix),_.geometry=Se,_.renderOrder=1/0,_.position.set(0,0,0),_.rotation.set(0,0,0),_.scale.set(1,1,1),ae.add(_)}return ae}this.gizmo={},this.picker={},this.helper={},this.add(this.gizmo.translate=V(g)),this.add(this.gizmo.rotate=V(C)),this.add(this.gizmo.scale=V(L)),this.add(this.picker.translate=V(D)),this.add(this.picker.rotate=V(W)),this.add(this.picker.scale=V(He)),this.add(this.helper.translate=V(x)),this.add(this.helper.rotate=V(j)),this.add(this.helper.scale=V(Fe)),this.picker.translate.visible=!1,this.picker.rotate.visible=!1,this.picker.scale.visible=!1}updateMatrixWorld(e){const i=(this.mode==="scale"?"local":this.space)==="local"?this.worldQuaternion:me;this.gizmo.translate.visible=this.mode==="translate",this.gizmo.rotate.visible=this.mode==="rotate",this.gizmo.scale.visible=this.mode==="scale",this.helper.translate.visible=this.mode==="translate",this.helper.rotate.visible=this.mode==="rotate",this.helper.scale.visible=this.mode==="scale";let s=[];s=s.concat(this.picker[this.mode].children),s=s.concat(this.gizmo[this.mode].children),s=s.concat(this.helper[this.mode].children);for(let a=0;a<s.length;a++){const n=s[a];n.visible=!0,n.rotation.set(0,0,0),n.position.copy(this.worldPosition);let o;if(this.camera.isOrthographicCamera?o=(this.camera.top-this.camera.bottom)/this.camera.zoom:o=this.worldPosition.distanceTo(this.cameraPosition)*Math.min(1.9*Math.tan(Math.PI*this.camera.fov/360)/this.camera.zoom,7),n.scale.set(1,1,1).multiplyScalar(o*this.size/4),n.tag==="helper"){n.visible=!1,n.name==="AXIS"?(n.visible=!!this.axis,this.axis==="X"&&(E.setFromEuler(he.set(0,0,0)),n.quaternion.copy(i).multiply(E),Math.abs(S.copy(te).applyQuaternion(i).dot(this.eye))>.9&&(n.visible=!1)),this.axis==="Y"&&(E.setFromEuler(he.set(0,0,Math.PI/2)),n.quaternion.copy(i).multiply(E),Math.abs(S.copy(X).applyQuaternion(i).dot(this.eye))>.9&&(n.visible=!1)),this.axis==="Z"&&(E.setFromEuler(he.set(0,Math.PI/2,0)),n.quaternion.copy(i).multiply(E),Math.abs(S.copy(ie).applyQuaternion(i).dot(this.eye))>.9&&(n.visible=!1)),this.axis==="XYZE"&&(E.setFromEuler(he.set(0,Math.PI/2,0)),S.copy(this.rotationAxis),n.quaternion.setFromRotationMatrix(Te.lookAt(ke,S,X)),n.quaternion.multiply(E),n.visible=this.dragging),this.axis==="E"&&(n.visible=!1)):n.name==="START"?(n.position.copy(this.worldPositionStart),n.visible=this.dragging):n.name==="END"?(n.position.copy(this.worldPosition),n.visible=this.dragging):n.name==="DELTA"?(n.position.copy(this.worldPositionStart),n.quaternion.copy(this.worldQuaternionStart),I.set(1e-10,1e-10,1e-10).add(this.worldPositionStart).sub(this.worldPosition).multiplyScalar(-1),I.applyQuaternion(this.worldQuaternionStart.clone().invert()),n.scale.copy(I),n.visible=this.dragging):(n.quaternion.copy(i),this.dragging?n.position.copy(this.worldPositionStart):n.position.copy(this.worldPosition),this.axis&&(n.visible=this.axis.search(n.name)!==-1));continue}n.quaternion.copy(i),this.mode==="translate"||this.mode==="scale"?(n.name==="X"&&Math.abs(S.copy(te).applyQuaternion(i).dot(this.eye))>.99&&(n.scale.set(1e-10,1e-10,1e-10),n.visible=!1),n.name==="Y"&&Math.abs(S.copy(X).applyQuaternion(i).dot(this.eye))>.99&&(n.scale.set(1e-10,1e-10,1e-10),n.visible=!1),n.name==="Z"&&Math.abs(S.copy(ie).applyQuaternion(i).dot(this.eye))>.99&&(n.scale.set(1e-10,1e-10,1e-10),n.visible=!1),n.name==="XY"&&Math.abs(S.copy(ie).applyQuaternion(i).dot(this.eye))<.2&&(n.scale.set(1e-10,1e-10,1e-10),n.visible=!1),n.name==="YZ"&&Math.abs(S.copy(te).applyQuaternion(i).dot(this.eye))<.2&&(n.scale.set(1e-10,1e-10,1e-10),n.visible=!1),n.name==="XZ"&&Math.abs(S.copy(X).applyQuaternion(i).dot(this.eye))<.2&&(n.scale.set(1e-10,1e-10,1e-10),n.visible=!1)):this.mode==="rotate"&&(de.copy(i),S.copy(this.eye).applyQuaternion(E.copy(i).invert()),n.name.search("E")!==-1&&n.quaternion.setFromRotationMatrix(Te.lookAt(this.eye,ke,X)),n.name==="X"&&(E.setFromAxisAngle(te,Math.atan2(-S.y,S.z)),E.multiplyQuaternions(de,E),n.quaternion.copy(E)),n.name==="Y"&&(E.setFromAxisAngle(X,Math.atan2(S.x,S.z)),E.multiplyQuaternions(de,E),n.quaternion.copy(E)),n.name==="Z"&&(E.setFromAxisAngle(ie,Math.atan2(S.y,S.x)),E.multiplyQuaternions(de,E),n.quaternion.copy(E))),n.visible=n.visible&&(n.name.indexOf("X")===-1||this.showX),n.visible=n.visible&&(n.name.indexOf("Y")===-1||this.showY),n.visible=n.visible&&(n.name.indexOf("Z")===-1||this.showZ),n.visible=n.visible&&(n.name.indexOf("E")===-1||this.showX&&this.showY&&this.showZ),n.material._color=n.material._color||n.material.color.clone(),n.material._opacity=n.material._opacity||n.material.opacity,n.material.color.copy(n.material._color),n.material.opacity=n.material._opacity,this.enabled&&this.axis&&(n.name===this.axis||this.axis.split("").some(function(c){return n.name===c}))&&(n.material.color.setHex(16776960),n.material.opacity=1)}super.updateMatrixWorld(e)}}class ht extends u{constructor(){super(new be(1e5,1e5,2,2),new Y({visible:!1,wireframe:!0,side:je,transparent:!0,opacity:.1,toneMapped:!1})),this.isTransformControlsPlane=!0,this.type="TransformControlsPlane"}updateMatrixWorld(e){let t=this.space;switch(this.position.copy(this.worldPosition),this.mode==="scale"&&(t="local"),ue.copy(te).applyQuaternion(t==="local"?this.worldQuaternion:me),J.copy(X).applyQuaternion(t==="local"?this.worldQuaternion:me),ee.copy(ie).applyQuaternion(t==="local"?this.worldQuaternion:me),S.copy(J),this.mode){case"translate":case"scale":switch(this.axis){case"X":S.copy(this.eye).cross(ue),H.copy(ue).cross(S);break;case"Y":S.copy(this.eye).cross(J),H.copy(J).cross(S);break;case"Z":S.copy(this.eye).cross(ee),H.copy(ee).cross(S);break;case"XY":H.copy(ee);break;case"YZ":H.copy(ue);break;case"XZ":S.copy(ee),H.copy(J);break;case"XYZ":case"E":H.set(0,0,0);break}break;case"rotate":default:H.set(0,0,0)}H.length()===0?this.quaternion.copy(this.cameraQuaternion):(Ie.lookAt(I.set(0,0,0),H,S),this.quaternion.setFromRotationMatrix(Ie)),super.updateMatrixWorld(e)}}class dt{constructor(e,t,i,s=null){this.scene=e,this.camera=t,this.renderer=i,this.viewer=s,this.isCreating=!1,this.previewObject=null,this.currentType="tunnel",this.currentPosition=new m(0,-2,0),this.parameters={tunnel:{width:3,height:3,length:10,orientation:"horizontal",angle:0},road:{width:4,height:.5,length:15,orientation:"horizontal",angle:0},rail:{width:1.5,height:.3,length:20,orientation:"horizontal",angle:0},conveyor:{width:1,height:.8,length:12,orientation:"horizontal",angle:0}},this.createdObjects=new Map,this.nextId=1,this.autoMultiPlace=!1}startCreating(e){this.isCreating=!0,this.currentType=e,this.showCreationUI(),this.createPreview(),console.log(`[MineObjectCreator] Started creating: ${e}`)}stopCreating(){this.isCreating=!1,this.hideCreationUI(),this.removePreview(),console.log("[MineObjectCreator] Stopped creating")}updateParameter(e,t){this.parameters[this.currentType]&&(e==="orientation"?this.parameters[this.currentType][e]=t:this.parameters[this.currentType][e]=parseFloat(t),this.updatePreview(),console.log(`[MineObjectCreator] Updated ${e}: ${t}`))}createPreview(){this.removePreview();const e=this.parameters[this.currentType],t=this.createGeometry(this.currentType,e),i=this.createPreviewMaterial(this.currentType);this.previewObject=new u(t,i),this.previewObject.position.copy(this.currentPosition),this.previewObject.name="preview_object",this.scene.add(this.previewObject)}updatePreview(){if(this.previewObject){const e=this.parameters[this.currentType],t=this.createGeometry(this.currentType,e);this.previewObject.geometry.dispose(),this.previewObject.geometry=t}}removePreview(){this.previewObject&&(this.scene.remove(this.previewObject),this.previewObject.geometry.dispose(),this.previewObject.material.dispose(),this.previewObject=null)}createGeometry(e,t){let i;switch(t&&t.orientation&&(t.orientation==="yatay"?t.orientation="horizontal":t.orientation==="dikey"&&(t.orientation="vertical")),e){case"tunnel":t.orientation==="vertical"?(i=new T(t.width/2,t.width/2,t.length,16,1,!1),t.angle&&t.angle!==0&&i.rotateY(t.angle*Math.PI/180)):(i=new T(t.height/2,t.height/2,t.length,16,1,!1),t.angle&&t.angle!==0&&i.rotateY(t.angle*Math.PI/180),i.rotateX(Math.PI/2),i.scale(t.width/t.height,1,1));break;case"road":i=new k(t.width,t.height,t.length);break;case"rail":i=new k(t.width,t.height,t.length);break;case"conveyor":i=new k(t.width,t.height,t.length);break;default:i=new k(2,2,2)}return e!=="tunnel"&&t.angle&&t.angle!==0&&(t.orientation==="vertical"?i.rotateY(t.angle*Math.PI/180):i.rotateZ(t.angle*Math.PI/180)),i}createPreviewMaterial(e){const t={tunnel:8421504,road:4210752,rail:6710886,conveyor:16766720};return new $({color:t[e]||8421504,transparent:!0,opacity:.6,wireframe:!1})}finalizeCreation(){var a;if(!this.previewObject)return null;const e=this.parameters[this.currentType],t=this.createGeometry(this.currentType,e),i=this.createFinalMaterial(this.currentType),s=new u(t,i);if(s.position.copy(this.previewObject.position),s.userData={id:this.nextId++,type:this.currentType,parameters:{...e},selectable:!0},this.scene.add(s),this.createdObjects.set(s.userData.id,s),this.viewer&&this.viewer.objectSelector)try{this.viewer.objectSelector.addSelectableObject(s,{id:s.userData.id,type:s.userData.type,name:`${s.userData.type.charAt(0).toUpperCase()+s.userData.type.slice(1)} ${s.userData.id}`,parameters:s.userData.parameters,color:"#"+s.material.color.getHexString()})}catch(n){console.warn("[MineObjectCreator] Selectable eklenemedi:",n)}if(this.removePreview(),console.log(`[MineObjectCreator] Created ${this.currentType} with ID: ${s.userData.id}`),this.autoMultiPlace)this.createPreview();else if(this.isCreating=!1,(a=this.hideCreationUI)==null||a.call(this),this.viewer&&(this.viewer.isCreatingMode=!1,typeof this.viewer.removePreview=="function"))try{this.viewer.removePreview()}catch{}return s}createFinalMaterial(e){const t={tunnel:8421504,road:4210752,rail:6710886,conveyor:16766720};return new $({color:t[e]||8421504,transparent:!1,opacity:1})}showCreationUI(){let e=document.getElementById("creation-panel");e||(e=this.createCreationPanel()),e.style.display="block",this.updateUIForType(this.currentType)}hideCreationUI(){const e=document.getElementById("creation-panel");e&&(e.style.display="none")}createCreationPanel(){const e=document.createElement("div");return e.id="creation-panel",e.className="creation-panel",e.style.cssText=`
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            min-width: 280px;
            z-index: 1000;
            display: none;
            font-family: Arial, sans-serif;
        `,e.innerHTML=`
            <h4 id="creation-title" style="margin-top: 0; color: #fff;">Tünel Oluştur</h4>
            
            <div class="parameter-group" style="margin-bottom: 15px;">
                <label for="param1" style="display: block; margin-bottom: 5px;">
                    Genişlik: <span id="param1-value" style="color: #4CAF50; font-weight: bold;">3</span>m
                </label>
                <input type="range" id="param1" min="1" max="10" step="0.5" value="3" 
                       style="width: 100%; margin-bottom: 5px;">
                <input type="number" id="param1-number" min="1" max="10" step="0.5" value="3"
                       style="width: 100%; padding: 4px; margin-bottom: 10px; background: #333; color: white; border: 1px solid #555; border-radius: 3px;">
                
                <label for="param2" style="display: block; margin-bottom: 5px;">
                    Yükseklik: <span id="param2-value" style="color: #4CAF50; font-weight: bold;">3</span>m
                </label>
                <input type="range" id="param2" min="1" max="8" step="0.5" value="3"
                       style="width: 100%; margin-bottom: 5px;">
                <input type="number" id="param2-number" min="1" max="8" step="0.5" value="3"
                       style="width: 100%; padding: 4px; margin-bottom: 10px; background: #333; color: white; border: 1px solid #555; border-radius: 3px;">
                
                <label for="param3" style="display: block; margin-bottom: 5px;">
                    Uzunluk: <span id="param3-value" style="color: #4CAF50; font-weight: bold;">10</span>m
                </label>
                <input type="range" id="param3" min="5" max="5000" step="1" value="10"
                       style="width: 100%; margin-bottom: 5px;">
                <input type="number" id="param3-number" min="5" max="5000" step="1" value="10"
                       style="width: 100%; padding: 4px; margin-bottom: 15px; background: #333; color: white; border: 1px solid #555; border-radius: 3px;">
            </div>
            
            <div id="tunnel-controls" class="tunnel-specific" style="margin-bottom: 15px; border-top: 1px solid #444; padding-top: 15px;">
                <label for="orientation" style="display: block; margin-bottom: 5px;">
                    Yönelim:
                </label>
                <select id="orientation" style="width: 100%; padding: 5px; margin-bottom: 10px; background: #333; color: white; border: 1px solid #555;">
                    <option value="horizontal">Yatay</option>
                    <option value="vertical">Dikey</option>
                </select>
                
                <label for="angle" style="display: block; margin-bottom: 5px;">
                    Açı: <span id="angle-value" style="color: #4CAF50; font-weight: bold;">0</span>°
                </label>
                <input type="range" id="angle" min="0" max="360" step="5" value="0"
                       style="width: 100%; margin-bottom: 10px;">
            </div>
            
            <div class="button-group" style="margin-top: 15px;">
                <button id="create-confirm" class="btn btn-success" 
                        style="background: #4CAF50; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-right: 10px; cursor: pointer;">
                    Oluştur
                </button>
                <button id="create-cancel" class="btn btn-secondary"
                        style="background: #666; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                    İptal
                </button>
            </div>
        `,document.body.appendChild(e),this.setupCreationPanelEvents(),e}setupCreationPanelEvents(){const e=document.getElementById("param1"),t=document.getElementById("param2"),i=document.getElementById("param3"),s=document.getElementById("param1-number"),a=document.getElementById("param2-number"),n=document.getElementById("param3-number"),o=document.getElementById("orientation"),c=document.getElementById("angle"),h=document.getElementById("create-confirm"),l=document.getElementById("create-cancel");e.addEventListener("input",d=>{const r=d.target.value;document.getElementById("param1-value").textContent=r,s.value=r,this.updateParameter("width",r)}),t.addEventListener("input",d=>{const r=d.target.value;document.getElementById("param2-value").textContent=r,a.value=r,this.updateParameter("height",r)}),i.addEventListener("input",d=>{const r=d.target.value;document.getElementById("param3-value").textContent=r,n.value=r,this.updateParameter("length",r)}),s.addEventListener("input",d=>{const r=d.target.value;document.getElementById("param1-value").textContent=r,e.value=r,this.updateParameter("width",r)}),a.addEventListener("input",d=>{const r=d.target.value;document.getElementById("param2-value").textContent=r,t.value=r,this.updateParameter("height",r)}),n.addEventListener("input",d=>{const r=d.target.value;document.getElementById("param3-value").textContent=r,i.value=r,this.updateParameter("length",r)}),o.addEventListener("change",d=>{this.updateParameter("orientation",d.target.value)}),c.addEventListener("input",d=>{document.getElementById("angle-value").textContent=d.target.value,this.updateParameter("angle",d.target.value)}),h.addEventListener("click",()=>{const d=this.finalizeCreation();d&&(this.stopCreating(),this.viewer&&this.viewer.saveObjectToServer(d))}),l.addEventListener("click",()=>{this.stopCreating()})}updateUIForType(e){const t={tunnel:"Tünel Oluştur",road:"Yol Oluştur",rail:"Ray Oluştur",conveyor:"Konveyör Oluştur"};document.getElementById("creation-title").textContent=t[e]||"Obje Oluştur";const i=this.parameters[e];document.getElementById("param1").value=i.width,document.getElementById("param1-value").textContent=i.width,document.getElementById("param1-number").value=i.width,document.getElementById("param2").value=i.height,document.getElementById("param2-value").textContent=i.height,document.getElementById("param2-number").value=i.height,document.getElementById("param3").value=i.length,document.getElementById("param3-value").textContent=i.length,document.getElementById("param3-number").value=i.length;const s=document.getElementById("tunnel-controls");e==="tunnel"?(s.style.display="block",document.getElementById("orientation").value=i.orientation||"horizontal",document.getElementById("angle").value=i.angle||0,document.getElementById("angle-value").textContent=i.angle||0):s.style.display="none"}async saveToServer(e){var t,i,s;try{const a={mine_id:this.mineId||1,name:`${e.userData.type.charAt(0).toUpperCase()+e.userData.type.slice(1)} ${e.userData.id}`,type:"model",geometry:{type:e.userData.type,...e.userData.parameters},material:{color:e.material.color.getHex(),opacity:e.material.opacity||1},position:[e.position.x,e.position.y,e.position.z],rotation:[e.rotation.x,e.rotation.y,e.rotation.z],scale:[e.scale.x,e.scale.y,e.scale.z],properties:{createdAt:new Date().toISOString(),tool:e.userData.type},visible:!0,order:e.userData.id},n=await fetch(`/api/mines/${this.mineId||1}/models`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":((t=document.querySelector('meta[name="csrf-token"]'))==null?void 0:t.getAttribute("content"))||"",Accept:"application/json"},body:JSON.stringify(a)});if(n.ok){const o=await n.json();e.userData.serverId=(i=o.data)==null?void 0:i.id,console.log("[MineObjectCreator] Successfully saved to server:",o)}else throw new Error(`HTTP ${n.status}: ${n.statusText}`)}catch(a){console.error("[MineObjectCreator] Error saving to server:",a),(s=this.showError)==null||s.call(this,"Obje kaydedilemedi: "+a.message)}}showError(e){const t=document.createElement("div");t.style.cssText=`
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #ff4444;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 10000;
        `,t.textContent=e,document.body.appendChild(t),setTimeout(()=>{document.body.removeChild(t)},3e3)}}class ut{constructor(e,t,i){this.scene=e,this.camera=t,this.renderer=i,this.isDrawing=!1,this.currentPath=[],this.tempPath=null,this.paths=new Map,this.raycaster=new U,this.mouse=new ne,this.groundPlane=new Me(new m(0,1,0),-2),this.tunnelConstraintMode=!1,this.constraintTunnel=null,this.currentDrawingType="tunnel",this.previewMesh=null,this.distanceLabel=null,this.drawingCallbacks={onPathStart:null,onPathUpdate:null,onPathComplete:null},this._lodFrame=0,this.debug=!1}startDrawing(e={}){this.stopDrawing(),this.isDrawing=!0,this.currentPath=[],this.drawingCallbacks={...this.drawingCallbacks,...e},console.log("[MinePathDrawer] Yol çizimi başladı - state temizlendi, type:",this.currentDrawingType)}setDrawingType(e){this.currentDrawingType=e,console.log("[MinePathDrawer] Drawing type set to:",e)}setAxisConstraint(e){this.axisConstraint=e,console.log("[MinePathDrawer] Axis constraint set to:",e)}stopDrawing(){this.isDrawing=!1,this.currentPath=[],this.removeTempPath(),this.removePreviewMesh(),this.removeDistanceLabel(),console.log("[MinePathDrawer] Yol çizimi durdu - temizlik yapıldı")}handleClick(e){if(!this.isDrawing)return;this.updateMousePosition(e);const t=this.getGroundIntersection();t&&(this.currentPath.push(t),this.updateTempPath(),this.drawingCallbacks.onPathUpdate&&this.drawingCallbacks.onPathUpdate(this.currentPath))}handleMouseMove(e){if(!this.isDrawing||this.currentPath.length===0)return;this.updateMousePosition(e);let t=this.getGroundIntersection();if(t){if(this.axisConstraint&&this.currentPath.length>0){const s=this.currentPath[this.currentPath.length-1];switch(this.axisConstraint){case"x":t.y=s.y,t.z=s.z;break;case"y":t.x=s.x,t.z=s.z;break;case"z":t.x=s.x,t.y=s.y;break}}this.viewer.constrainToAxis&&(t=this.viewer.constrainToAxis(t)),this.updatePreview(t);const i=[...this.currentPath,t];this.updateTempPath(i)}}updateMousePosition(e){const t=this.renderer.domElement.getBoundingClientRect();this.mouse.x=(e.clientX-t.left)/t.width*2-1,this.mouse.y=-((e.clientY-t.top)/t.height)*2+1}getGroundIntersection(){this.raycaster.setFromCamera(this.mouse,this.camera);const e=new m;if(this.tunnelConstraintMode&&this.constraintTunnel){const t=this.raycaster.intersectObject(this.constraintTunnel,!0);if(t.length>0){const i=t[0].point;return i.y=-2.5,this.debug&&console.log("[MinePathDrawer] Tunnel constraint intersection found:",{x:i.x.toFixed(2),y:i.y.toFixed(2),z:i.z.toFixed(2)}),i}else return this.debug&&console.log("[MinePathDrawer] No tunnel constraint intersection found"),null}else return this.raycaster.ray.intersectPlane(this.groundPlane,e)?(this.debug&&console.log("[MinePathDrawer] Ground intersection found:",{x:e.x.toFixed(2),y:e.y.toFixed(2),z:e.z.toFixed(2)}),e):(this.debug&&console.log("[MinePathDrawer] No ground intersection found"),null)}updateTempPath(e=null){this.removeTempPath();const t=e||this.currentPath;if(t.length<2)return;const i=new se().setFromPoints(t),s=new N({color:16711680,linewidth:3,opacity:.8,transparent:!0});this.tempPath=new A(i,s),this.scene.add(this.tempPath)}removeTempPath(){this.tempPath&&(console.log("[MinePathDrawer] Removing temp path"),this.scene.remove(this.tempPath),this.tempPath.geometry.dispose(),this.tempPath.material.dispose(),this.tempPath=null)}completePath(){if(this.currentPath.length<2)return console.log("[MinePathDrawer] Complete path failed: not enough points"),null;console.log("[MinePathDrawer] Completing path with",this.currentPath.length,"points"),this.removeTempPath(),this.drawingCallbacks.onPathComplete&&this.drawingCallbacks.onPathComplete(this.currentPath);const e=[...this.currentPath];return this.currentPath=[],e}createPath(e){const{id:t,points:i,width:s=2.5,height:a=2.5,color:n="#808080",type:o="tunnel"}=e;if(!i||i.length<2)return null;const c=this.createPathMesh(i,s,a,n,o);return c.userData={id:t,type:o,pathData:e},this.paths.set(t,c),this.scene.add(c),console.log(`[MinePathDrawer] Yol oluşturuldu: ${t}, boyutlar: ${s}x${a}`),c}createPathMesh(e,t,i,s,a){const n=new Be,o=this.createTubeGeometry(e,t,i),c=this.createPathMaterial(s,a),h=new u(o,c);h.castShadow=!0,h.receiveShadow=!0;const l=this.createTubeGeometry(e,t,i,{quality:"low"});h.userData.highGeometry=o,h.userData.lowGeometry=l,h.userData.lodState="high",n.add(h);const d=new Ae(o),r=new N({color:new ve(s).multiplyScalar(.5),opacity:.6,transparent:!0,linewidth:1}),f=new Le(d,r);return n.add(f),a==="conveyor"?this.addConveyorBelt(n,e,t):a==="rail"&&this.addRailTracks(n,e,t),n}createPathMaterial(e,t){const i=new ve(e);switch(t){case"tunnel":return new $({color:i,transparent:!0,opacity:.9,shininess:30,specular:4473924});case"road":return new pe({color:i.multiplyScalar(.7),transparent:!0,opacity:.95});case"rail":return new $({color:i,metalness:.7,roughness:.3,transparent:!0,opacity:.9});case"conveyor":return new $({color:i,transparent:!0,opacity:.8,shininess:50,specular:8947848});default:return new pe({color:i,transparent:!0,opacity:.9})}}createTubeGeometry(e,t,i,s={}){if(e.length<2)return new k(1,1,1);const a=new q(e);a.tension=.2;const n=Math.max(e.length*6,24);let o=n;s.quality==="low"&&(o=Math.max(Math.floor(n*.35),8)),o=Math.min(o,360);const c=s.quality==="low"?8:16,h=new Z(a,o,Math.max(t,i)/2,c,!1),l=h.attributes.position.array;for(let d=0;d<l.length;d+=3){const r=l[d],f=l[d+1],p=l[d+2];if(Math.sqrt(r*r+p*p)>0){const b=Math.atan2(p,r),v=t*i/Math.sqrt((i*Math.cos(b))**2+(t*Math.sin(b))**2)/(Math.max(t,i)/2);l[d]=r*v,l[d+2]=p*v,f<0&&(l[d+1]=f*.8)}}return h.attributes.position.needsUpdate=!0,h.computeVertexNormals(),h}updateLOD(){if(this._lodFrame++,this._lodFrame%10===0)for(const[,e]of this.paths){if(!e)continue;const t=e.children.find(n=>n.isMesh);if(!t||!t.userData.highGeometry)continue;t.userData._bs||(t.userData.highGeometry.computeBoundingSphere(),t.userData._bs=t.userData.highGeometry.boundingSphere.clone());const i=t.userData._bs.center.clone();e.localToWorld(i);const a=i.distanceTo(this.camera.position)>180?"low":"high";a!==t.userData.lodState&&(a==="low"?(t.geometry=t.userData.lowGeometry,t.userData.lodState="low"):(t.geometry=t.userData.highGeometry,t.userData.lodState="high"))}}addConveyorBelt(e,t,i){const s=new q(t),a=new Z(s,t.length*2,i/3,8,!1),n=new $({color:3355443,shininess:100,transparent:!0,opacity:.8}),o=new u(a,n);o.position.y+=.1,e.add(o)}addRailTracks(e,t,i){const s=new q(t),a=new Z(s,t.length*4,.05,6,!1),n=new $({color:6710886,metalness:.8,roughness:.2}),o=new u(a,n.clone());o.position.x-=i/3,o.position.y+=.05,e.add(o);const c=new u(a.clone(),n.clone());c.position.x+=i/3,c.position.y+=.05,e.add(c)}removePath(e){const t=this.paths.get(e);t&&(this.scene.remove(t),t.traverse(i=>{i.geometry&&i.geometry.dispose(),i.material&&(Array.isArray(i.material)?i.material.forEach(s=>s.dispose()):i.material.dispose())}),this.paths.delete(e),console.log(`[MinePathDrawer] Yol silindi: ${e}`))}clearAllPaths(){for(const[e,t]of this.paths)this.removePath(e);console.log("[MinePathDrawer] Tüm yollar silindi")}getPath(e){return this.paths.get(e)}getAllPaths(){return Array.from(this.paths.values())}calculatePathLength(e){if(!e||e.length<2)return 0;let t=0;for(let i=1;i<e.length;i++){const s=e[i-1],a=e[i],n=a.x-s.x,o=a.y-s.y,c=a.z-s.z;t+=Math.sqrt(n*n+o*o+c*c)}return t}enableTunnelConstraint(e){this.tunnelConstraintMode=!0,this.constraintTunnel=e,console.log("[MinePathDrawer] Tunnel constraint mode enabled")}disableTunnelConstraint(){this.tunnelConstraintMode=!1,this.constraintTunnel=null,console.log("[MinePathDrawer] Tunnel constraint mode disabled")}updatePreview(e){if(!this.isDrawing||this.currentPath.length===0)return;const t=[...this.currentPath,e];this.createPreviewMesh(t),this.updateDistanceLabel(e)}createPreviewMesh(e){if(this.removePreviewMesh(),e.length<2)return;let t,i;switch(this.currentDrawingType){case"tunnel":t=this.createTubeGeometry(e,2.5,2.5),i=new Y({color:6710886,transparent:!0,opacity:.3,wireframe:!0});break;case"road":t=this.createRoadGeometry(e,3),i=new Y({color:3355443,transparent:!0,opacity:.4});break;case"rail":t=this.createRailGeometry(e,1.5),i=new Y({color:6710886,transparent:!0,opacity:.5});break;case"conveyor":t=this.createConveyorGeometry(e,1),i=new Y({color:4473924,transparent:!0,opacity:.4});break;default:t=new se().setFromPoints(e),i=new N({color:16711680,transparent:!0,opacity:.7})}this.currentDrawingType==="tunnel"||this.currentDrawingType==="road"||this.currentDrawingType==="rail"||this.currentDrawingType==="conveyor"?this.previewMesh=new u(t,i):this.previewMesh=new A(t,i),this.scene.add(this.previewMesh)}removePreviewMesh(){this.previewMesh&&(this.scene.remove(this.previewMesh),this.previewMesh.geometry&&this.previewMesh.geometry.dispose(),this.previewMesh.material&&this.previewMesh.material.dispose(),this.previewMesh=null)}updateDistanceLabel(e){if(this.currentPath.length===0)return;const i=this.currentPath[this.currentPath.length-1].distanceTo(e);this.updateDistanceDisplay(i)}updateDistanceDisplay(e){const t=document.getElementById("distance-display"),i=document.getElementById("distance-value");t&&i&&(t.style.display="block",i.textContent=`${e.toFixed(1)}m`)}removeDistanceLabel(){const e=document.getElementById("distance-display");e&&(e.style.display="none")}createRoadGeometry(e,t){const i=new q(e);return new Z(i,e.length*2,t/2,8,!1)}createRailGeometry(e,t){const i=new q(e);return new Z(i,e.length*2,.1,6,!1)}createConveyorGeometry(e,t){const i=new q(e);return new Z(i,e.length*2,t/2,6,!1)}}class mt{constructor(e,t,i,s){this.scene=e,this.camera=t,this.renderer=i,this.pathDrawer=s,this.raycaster=new U,this.mouse=new ne,this.isEditing=!1,this.activePath=null,this.handles=[],this.draggingHandle=null,this.dragPlane=new Me(new m(0,1,0),0),this.offset=new m,this.intersection=new m,this.callbacks={onPointChange:null,onEditStart:null,onEditEnd:null},this.undoStack=[],this.redoStack=[],this.maxHistory=50}setCallbacks(e){this.callbacks={...this.callbacks,...e}}startEditing(e){if(!e||!e.userData||!e.userData.pathData)return;this.stopEditing(),this.isEditing=!0,this.activePath=e;const t=e.userData.pathData,i=(t.points||t.path_points||[]).map(a=>({...a}));this.undoStack=[i],this.redoStack=[],this.buildHandles(),this.callbacks.onEditStart&&this.callbacks.onEditStart(e);const s=document.getElementById("save-path-btn");s&&(s.disabled=!1)}stopEditing(){this.clearHandles(),this.isEditing=!1,this.activePath=null,this.draggingHandle=null,this.callbacks.onEditEnd&&this.callbacks.onEditEnd();const e=document.getElementById("save-path-btn");e&&(e.disabled=!0)}buildHandles(){this.clearHandles();const e=this.activePath.userData.pathData,t=e.points||e.path_points||[],i=new _e(.6,12,12),s=new Y({color:16763904});t.forEach((a,n)=>{const o=new u(i.clone(),s.clone());o.position.set(a.x,a.y,a.z),o.userData.isPathHandle=!0,o.userData.pointIndex=n,this.scene.add(o),this.handles.push({mesh:o,index:n})})}clearHandles(){this.handles.forEach(e=>{this.scene.remove(e.mesh),e.mesh.geometry.dispose(),e.mesh.material.dispose()}),this.handles=[]}updateMouse(e){const t=this.renderer.domElement.getBoundingClientRect();this.mouse.x=(e.clientX-t.left)/t.width*2-1,this.mouse.y=-((e.clientY-t.top)/t.height)*2+1}pointerDown(e){if(!this.isEditing)return;this.updateMouse(e),this.raycaster.setFromCamera(this.mouse,this.camera);const t=this.raycaster.intersectObjects(this.handles.map(i=>i.mesh),!0);if(t.length>0){const i=t[0].object;this.draggingHandle=this.handles.find(s=>s.mesh===i),this.dragPlane.set(new m(0,1,0),-i.position.y)}}pointerMove(e){if(!this.isEditing||!this.draggingHandle)return;this.updateMouse(e),this.raycaster.setFromCamera(this.mouse,this.camera);const t=new m;if(this.raycaster.ray.intersectPlane(this.dragPlane,t)){const i=this.draggingHandle;t.y=-2.5,i.mesh.position.copy(t),this.applyHandlePosition(i.index,t,{skipHistory:!0,skipDirty:!0})}}pointerUp(){var e;if(this.isEditing){if(this.draggingHandle){const t=(e=this.activePath)==null?void 0:e.userData.pathData;t&&t.points&&(this.pushHistory(t.points),this.viewer&&this.viewer.markPathDirty(t.id||t.path_id||this.activePath.userData.id))}this.draggingHandle=null}}applyHandlePosition(e,t,i={}){if(!this.activePath)return;const s=this.activePath.userData.pathData,a=s.points||s.path_points||[];if(!a[e])return;a[e]={x:t.x,y:t.y,z:t.z};const n=this.viewer&&this.viewer.pathSimplifyMultiplier?this.viewer.pathSimplifyMultiplier:1,o=gt(a,n),c=pt(a,o);this.rebuildPath(c,s),this.callbacks.onPointChange&&this.callbacks.onPointChange(c,s),i.skipHistory||this.pushHistory(c),!i.skipDirty&&this.viewer&&this.viewer.markPathDirty(s.id||s.path_id||this.activePath.userData.id)}pushHistory(e){const t=e.map(s=>({...s})),i=this.undoStack[this.undoStack.length-1];i&&i.length===t.length&&i.every((s,a)=>s.x===t[a].x&&s.y===t[a].y&&s.z===t[a].z)||(this.undoStack.push(t),this.undoStack.length>this.maxHistory&&this.undoStack.shift(),this.redoStack=[])}undo(){if(this.undoStack.length<=1)return;const e=this.undoStack.pop();this.redoStack.push(e);const t=this.undoStack[this.undoStack.length-1];this.applyHistoryState(t)}redo(){if(this.redoStack.length===0)return;const e=this.redoStack.pop();this.undoStack.push(e),this.applyHistoryState(e)}applyHistoryState(e){if(!this.activePath)return;const t=this.activePath.userData.pathData;this.rebuildPath(e,t),this.callbacks.onPointChange&&this.callbacks.onPointChange(e,t),this.clearHandles(),this.buildHandles()}rebuildPath(e,t){const i=this.activePath;[...i.children].forEach(l=>{i.remove(l),l.geometry&&l.geometry.dispose(),l.userData&&(l.userData.lowGeometry&&l.userData.lowGeometry!==l.geometry&&(l.userData.lowGeometry.dispose(),l.userData.lowGeometry=null),l.userData.highGeometry&&l.userData.highGeometry!==l.geometry&&(l.userData.highGeometry!==l.geometry&&l.userData.highGeometry.dispose(),l.userData.highGeometry=null)),l.material&&(Array.isArray(l.material)?l.material.forEach(d=>d.dispose()):l.material.dispose())});const a=t.width||2.5,n=t.height||2.5,o=t.color||"#808080",c=t.type||"tunnel";this.pathDrawer.createPathMesh(e.map(l=>new m(l.x,l.y,l.z)),a,n,o,c).children.forEach(l=>i.add(l)),t.points=e,t.path_points=e,this.clearHandles(),this.buildHandles(),i.traverse(l=>{l.userData&&l.userData._bs&&(l.userData._bs=null)})}}function pt(y,e){if(!y||y.length<3)return y;const t=e*e;function i(n,o,c){let h=o.x,l=o.y,d=o.z,r=c.x-h,f=c.y-l,p=c.z-d;if(r!==0||f!==0||p!==0){let w=((n.x-h)*r+(n.y-l)*f+(n.z-d)*p)/(r*r+f*f+p*p);w>1?(h=c.x,l=c.y,d=c.z):w>0&&(h+=r*w,l+=f*w,d+=p*w)}return r=n.x-h,f=n.y-l,p=n.z-d,r*r+f*f+p*p}function s(n,o,c,h,l){let d=h,r=-1;for(let f=o+1;f<c;f++){const p=i(n[f],n[o],n[c]);p>d&&(r=f,d=p)}d>h&&r!==-1&&(r-o>1&&s(n,o,r,h,l),l.push(n[r]),c-r>1&&s(n,r,c,h,l))}const a=[y[0]];return s(y,0,y.length-1,t,a),a.push(y[y.length-1]),a}function gt(y,e=1){if(!y||y.length<3)return .05*e;let t=0;for(let l=1;l<y.length;l++){const d=y[l].x-y[l-1].x,r=y[l].y-y[l-1].y,f=y[l].z-y[l-1].z;t+=Math.sqrt(d*d+r*r+f*f)}let i=0,s=0;for(let l=1;l<y.length-1;l++){const d=y[l-1],r=y[l],f=y[l+1],p=r.x-d.x,w=r.y-d.y,b=r.z-d.z,M=f.x-r.x,v=f.y-r.y,P=f.z-r.z,O=Math.sqrt(p*p+w*w+b*b)+1e-6,g=Math.sqrt(M*M+v*v+P*P)+1e-6,D=(p*M+w*v+b*P)/(O*g),x=Math.acos(Math.min(1,Math.max(-1,D)));i+=x,s++}const a=s?i/s:0,n=Math.min(1,t/500),o=1-Math.min(1,a/.8),h=(.05+.4*n*o)*e;return Math.min(1,Math.max(.02,h))}class yt{constructor(e,t,i){this.scene=e,this.camera=t,this.renderer=i,this.raycaster=new U,this.mouse=new ne,this.selectedObject=null,this.multiSelect=!0,this.selectedObjects=new Set,this.selectableObjects=new Set,this.highlightMaterial=new Y({color:16729156,transparent:!0,opacity:.3,depthTest:!1}),this.outlineColor=16711680,this.xrayModeObject=null,this.originalMaterials=new Map,this.callbacks={onObjectSelect:null,onObjectDeselect:null,onObjectDelete:null}}setCallbacks(e){this.callbacks={...this.callbacks,...e}}addSelectableObject(e,t={}){e.userData.selectable=!0,e.userData.objectData=t,this.selectableObjects.add(e)}removeSelectableObject(e){this.selectableObjects.delete(e),this.selectedObject===e&&this.deselectObject()}handleClick(e){this.updateMousePosition(e),this.raycaster.setFromCamera(this.mouse,this.camera);const t=Array.from(this.selectableObjects),i=this.raycaster.intersectObjects(t,!0);if(i.length>0){let s=null;for(const a of i){let n=a.object;for(;n&&!n.userData.selectable;)n=n.parent;if(n&&this.selectableObjects.has(n)){s=n;break}}if(s){const a=e.shiftKey;this.multiSelect&&a?this.selectedObjects.has(s)?this.deselectObject(s):this.addToSelection(s):(this.clearMultiSelection(),this.selectObject(s))}}else this.clearMultiSelection(),this.deselectObject()}updateMousePosition(e){const t=this.renderer.domElement.getBoundingClientRect();this.mouse.x=(e.clientX-t.left)/t.width*2-1,this.mouse.y=-((e.clientY-t.top)/t.height)*2+1}selectObject(e){if(this.selectedObject===e){e.userData.objectData&&e.userData.objectData.pathType==="tunnel"&&this.toggleXRayMode(e);return}this.deselectObject(),this.selectedObject=e,this.selectedObjects.add(e),this.addHighlight(e),e.userData.objectData&&e.userData.objectData.pathType==="tunnel"&&this.enableXRayMode(e),this.callbacks.onObjectSelect&&this.callbacks.onObjectSelect(e,e.userData.objectData)}deselectObject(){this.selectedObject&&(this.removeHighlight(this.selectedObject),this.disableXRayMode(),this.callbacks.onObjectDeselect&&this.callbacks.onObjectDeselect(this.selectedObject),this.selectedObject=null)}deleteSelectedObject(){if(this.selectedObject){const e=this.selectedObject;this.deselectObject(),this.callbacks.onObjectDelete&&this.callbacks.onObjectDelete(e)}}addHighlight(e){e.traverse(t=>{if(t.isMesh&&t.geometry){const i=new Ae(t.geometry),s=new Le(i,new N({color:this.outlineColor,linewidth:3}));s.name="highlight_outline",t.add(s)}})}removeHighlight(e){e.traverse(t=>{const i=t.getObjectByName("highlight_outline");i&&(t.remove(i),i.geometry.dispose(),i.material.dispose())})}deselectObject(e=null){if(e){this.removeHighlight(e),this.xrayModeObject===e&&this.disableXRayMode(),this.selectedObjects.delete(e),this.selectedObject===e&&(this.selectedObject=null),this.callbacks.onObjectDeselect&&this.callbacks.onObjectDeselect(e);return}this.selectedObject&&(this.removeHighlight(this.selectedObject),this.xrayModeObject===this.selectedObject&&this.disableXRayMode(),this.callbacks.onObjectDeselect&&this.callbacks.onObjectDeselect(this.selectedObject)),this.selectedObject=null,this.selectedObjects.clear()}addToSelection(e){this.selectedObjects.has(e)||(this.selectedObjects.add(e),this.addHighlight(e),this.callbacks.onObjectSelect&&this.callbacks.onObjectSelect(e,e.userData.objectData))}clearMultiSelection(){if(this.selectedObjects.size>1){for(const e of this.selectedObjects)e!==this.selectedObject&&this.removeHighlight(e);this.selectedObjects=this.selectedObject?new Set([this.selectedObject]):new Set}}enableXRayMode(e){this.xrayModeObject!==e&&(this.disableXRayMode(),this.xrayModeObject=e,e.traverse(t=>{if(t.isMesh){this.originalMaterials.set(t,t.material.clone());const i=t.material.clone();i.transparent=!0,i.opacity=.3,i.side=je,t.material=i}}),console.log("[ObjectSelector] X-Ray mode enabled for tunnel"))}disableXRayMode(){this.xrayModeObject&&(this.xrayModeObject.traverse(e=>{e.isMesh&&this.originalMaterials.has(e)&&(e.material.dispose(),e.material=this.originalMaterials.get(e),this.originalMaterials.delete(e))}),this.xrayModeObject=null,console.log("[ObjectSelector] X-Ray mode disabled"))}toggleXRayMode(e){this.xrayModeObject===e?this.disableXRayMode():this.enableXRayMode(e)}}class ft{constructor(e,t){if(console.log("%c[SimpleMine3DViewer] Constructor called","color: blue; font-weight: bold;"),console.log("[SimpleMine3DViewer] Parameters:",{containerId:e,mineId:t}),this.containerId=e,this.mineId=t,this.container=document.getElementById(e),console.log("[SimpleMine3DViewer] Container element:",this.container),!this.container){const i=`Container with id "${e}" not found`;throw console.error("[SimpleMine3DViewer]",i),new Error(i)}console.log("[SimpleMine3DViewer] THREE.js (ESM) version:",Ye),this.scene=null,this.camera=null,this.renderer=null,this.controls=null,this.pathDrawer=null,this.pathEditor=null,this.objectCreator=null,this.transformControls=null,this.isPathDrawingMode=!1,this.isCreatingMode=!1,this.selectedObject=null,this.objectSelector=null,console.log("[SimpleMine3DViewer] Starting initialization..."),this._dirtyPaths=new Set,this._dirtyIndicatorEl=null,this.measurementsEnabled=!0,this.measurementStep=5,this._lastMeasuredTunnel=null,this.autoSaveSelection=!0,this.autoSaveDelay=800,this._autoSaveTimer=null,this._autoSaveInFlight=!1,this.init()}_getSelEls(){return this._selCache||(this._selCache={card:document.getElementById("selection-detail-card"),title:document.getElementById("sel-title"),meta:document.getElementById("sel-meta"),dyn:document.getElementById("sel-dynamic-fields"),gen:document.getElementById("sel-generic-fields"),status:document.getElementById("sel-status"),saveBtn:document.getElementById("sel-save-btn"),deleteBtn:document.getElementById("sel-delete-btn"),closeBtn:document.getElementById("sel-close-btn")},this._selCache.closeBtn&&this._selCache.closeBtn.addEventListener("click",()=>this.hideSelectionCard()),this._selCache.deleteBtn&&this._selCache.deleteBtn.addEventListener("click",()=>{var e;if(this.selectedObject&&confirm("Seçili nesneyi silmek istiyor musunuz?")){const t=this.selectedObject.userData.objectData||this.selectedObject.userData;t&&t.type==="path"?(e=this.objectSelector)==null||e.deleteSelectedObject():this.deleteSelectedObject()}}),this._selCache.saveBtn&&this._selCache.saveBtn.addEventListener("click",()=>this.saveSelectionEdits())),this._selCache}showSelectionCard(e,t){const i=this._getSelEls();i.card&&(i.card.style.display="block",this.populateSelectionCard(e,t))}hideSelectionCard(){const e=this._getSelEls();e.card&&(e.card.style.display="none")}markSelectionDirty(e=!0){const t=this._getSelEls();t.saveBtn&&(e?(t.saveBtn.disabled=!1,t.saveBtn.classList.add("btn-warning"),this.autoSaveSelection&&(clearTimeout(this._autoSaveTimer),this._autoSaveTimer=setTimeout(async()=>{if(!this._autoSaveInFlight){this._autoSaveInFlight=!0;try{await this.saveSelectionEdits()}catch(i){console.warn("[AutoSave] Selection auto-save failed:",i.message)}finally{this._autoSaveInFlight=!1}}},this.autoSaveDelay))):(t.saveBtn.disabled=!0,t.saveBtn.classList.remove("btn-warning")))}populateSelectionCard(e,t){var o,c;const i=this._getSelEls();if(!i.card)return;t=t||((o=e==null?void 0:e.userData)==null?void 0:o.objectData)||(e==null?void 0:e.userData)||{};const s=t.type==="path",a=t.type==="tunnel"||t.pathType==="tunnel";if(i.title&&(i.title.innerHTML=`<i class="fas fa-cube me-1"></i>${t.name||"Obje"}${s?' <span class="badge bg-info ms-1">Path</span>':""}`),i.meta&&(i.meta.innerHTML=`ID: <span class="text-light">${t.id??"-"}</span> · Tip: <span class="text-light">${t.pathType||t.type||"-"}</span>`),i.dyn){let h="";if(s)h+=this._buildNumberField("Genişlik (m)","sel-width",t.width,.1,100,.1),h+=this._buildNumberField("Yükseklik (m)","sel-height",t.height,.1,100,.1),h+=`<div class="mb-2"><label class="form-label mb-1">Segment Sayısı</label><div class="form-control form-control-sm bg-dark text-light">${(t.points||[]).length}</div></div>`,h+=`<div class="mb-2"><label class="form-label mb-1">Uzunluk</label><div class="form-control form-control-sm bg-dark text-light">${(t.length||0).toFixed(2)} m</div></div>`,h+=this._buildColorField("Renk","sel-color",t.color||"#808080");else if(a&&((c=e==null?void 0:e.userData)!=null&&c.parameters)){const l=e.userData.parameters;h+=this._buildNumberField("Genişlik (m)","sel-width",l.width,.5,50,.1),h+=this._buildNumberField("Yükseklik (m)","sel-height",l.height,.5,50,.1),h+=this._buildNumberField("Uzunluk (m)","sel-length",l.length,1,1e4,.5),h+=this._buildSelectField("Yön","sel-orientation",["yatay","dikey"],l.orientation),h+=this._buildNumberField("Açı (°)","sel-angle",l.angle||0,0,360,1),h+=this._buildColorField("Renk","sel-color",t.color||"#808080"),h+=this._buildNumberField("Ölçüm Adımı (m)","sel-meas-step",this.measurementStep,1,100,1)}else h+='<div class="text-muted small">Bu obje için düzenlenebilir alan yok.</div>';i.dyn.innerHTML=h}i.gen&&(i.gen.innerHTML=`<div class="mb-2"><label class="form-label mb-1">Pozisyon</label><div class="form-control form-control-sm bg-dark text-light">${e.position.x.toFixed(2)}, ${e.position.y.toFixed(2)}, ${e.position.z.toFixed(2)}</div></div>`),["sel-width","sel-height","sel-length","sel-angle","sel-orientation","sel-color"].forEach(h=>{const l=document.getElementById(h);l&&l.addEventListener("input",()=>{this.markSelectionDirty(!0),this._liveSelectionChange(h)})});const n=document.getElementById("sel-meas-step");n&&n.addEventListener("input",()=>{const h=parseInt(n.value,10);!isNaN(h)&&h>0&&(this.measurementStep=h,a&&this.buildTunnelMeasurements(e,t))}),this.markSelectionDirty(!1),i.status&&(i.status.textContent="")}_liveSelectionChange(e){if(!this.selectedObject)return;const t=this.selectedObject.userData&&(this.selectedObject.userData.objectData||this.selectedObject.userData)||{},i=t.type==="path",s=t.type==="tunnel"||t.pathType==="tunnel";if(i){const a=this.selectedObject,n=document.getElementById("sel-width"),o=document.getElementById("sel-height"),c=document.getElementById("sel-color"),h=parseFloat(n==null?void 0:n.value),l=parseFloat(o==null?void 0:o.value),d=c==null?void 0:c.value,r=a.userData.objectData||t;let f=!1;if(!isNaN(h)&&h>0&&h!==r.width&&(r.width=h,f=!0),!isNaN(l)&&l>0&&l!==r.height&&(r.height=l,f=!0),d&&d!==r.color&&(r.color=d,f=!0),f){const p=(r.points||r.path_points||[]).map(w=>new m(w.x,w.y,w.z));if(p.length>=2&&this.pathDrawer){const w=r.width||2.5,b=r.height||2.5,M=r.color||"#808080",v=r.pathType||r.type||"tunnel";if(!(this.pathEditor&&this.pathEditor.isEditing&&this.pathEditor.activePath===a)){for(;a.children.length;){const g=a.children.pop();g.geometry&&g.geometry.dispose(),g.material&&(Array.isArray(g.material)?g.material.forEach(D=>D.dispose()):g.material.dispose()),a.remove(g)}this.pathDrawer.createPathMesh(p,w,b,M,v).children.forEach(g=>a.add(g)),r.length=this.pathDrawer.calculatePathLength(p.map(g=>({x:g.x,y:g.y,z:g.z})));const O=document.getElementById("sel-dynamic-fields");O&&O.innerHTML.includes("Uzunluk")&&O.querySelectorAll("div")}}}}else if(s){const a={...this.selectedObject.userData.parameters||{}},n=document.getElementById("sel-width"),o=document.getElementById("sel-height"),c=document.getElementById("sel-length"),h=document.getElementById("sel-angle"),l=document.getElementById("sel-orientation"),d=document.getElementById("sel-color");let r=!1,f=!1;if(n&&!isNaN(parseFloat(n.value))&&parseFloat(n.value)!==a.width&&(a.width=parseFloat(n.value),r=!0),o&&!isNaN(parseFloat(o.value))&&parseFloat(o.value)!==a.height&&(a.height=parseFloat(o.value),r=!0),c&&!isNaN(parseFloat(c.value))&&parseFloat(c.value)!==a.length&&(a.length=parseFloat(c.value),r=!0),h&&!isNaN(parseFloat(h.value))&&parseFloat(h.value)!==a.angle&&(a.angle=parseFloat(h.value),r=!0),l&&l.value&&l.value!==a.orientation&&(f=!0,a.orientation=l.value,r=!0),d&&d.value&&this.selectedObject.material&&"#"+this.selectedObject.material.color.getHexString()!==d.value&&this.selectedObject.material.color.set(d.value),r&&(this.replaceTunnelGeometry(this.selectedObject,a),f&&this.camera&&this.controls)){const p=this.selectedObject.position.clone(),w=this.camera.position.distanceTo(p);let b;a.orientation==="dikey"||a.orientation==="vertical"?b=new m(p.x+w*.6,p.y+w*.8,p.z+w*.3):b=new m(p.x+w*.6,p.y+w*.3,p.z+w*.8);const M=this.camera.position.clone(),v=performance.now(),P=650,O=g=>{const D=Math.min(1,(g-v)/P),x=D<.5?2*D*D:-1+(4-2*D)*D;this.camera.position.lerpVectors(M,b,x),this.controls.target.lerpVectors(this.controls.target.clone(),p,x),D<1?requestAnimationFrame(O):this.controls.update()};requestAnimationFrame(O)}}}_buildNumberField(e,t,i,s,a,n){return i==null&&(i=""),`<div class="mb-2"><label class="form-label mb-1" for="${t}">${e}</label><input type="number" class="form-control form-control-sm bg-dark text-light" id="${t}" value="${i}" min="${s}" max="${a}" step="${n}"></div>`}_buildColorField(e,t,i){return`<div class="mb-2"><label class="form-label mb-1" for="${t}">${e}</label><input type="color" class="form-control form-control-color form-control-sm p-0 bg-dark border-0" id="${t}" value="${i}" title="Renk seç"></div>`}_buildSelectField(e,t,i,s){let a=o=>o;if(t==="sel-orientation"){const o={horizontal:"Yatay",vertical:"Dikey",yatay:"Yatay",dikey:"Dikey"};a=c=>o[c]||c,s==="horizontal"&&(s="yatay"),s==="vertical"&&(s="dikey"),i=i.map(c=>c==="horizontal"?"yatay":c==="vertical"?"dikey":c)}const n=i.map(o=>`<option value="${o}" ${o===s?"selected":""}>${a(o)}</option>`).join("");return`<div class="mb-2"><label class="form-label mb-1" for="${t}">${e}</label><select class="form-select form-select-sm bg-dark text-light" id="${t}">${n}</select></div>`}async saveSelectionEdits(){var s,a,n,o,c,h,l,d,r,f;const e=this._getSelEls();if(!this.selectedObject||!e.saveBtn)return;const t=this.selectedObject.userData.objectData||this.selectedObject.userData||{},i=t.type==="path";try{if(i){const p={},w=parseFloat((s=document.getElementById("sel-width"))==null?void 0:s.value),b=parseFloat((a=document.getElementById("sel-height"))==null?void 0:a.value),M=(n=document.getElementById("sel-color"))==null?void 0:n.value;isNaN(w)||(p.width=w),isNaN(b)||(p.height=b),M&&(p.color=M),await this.updatePathToServer(t.id,p)}else if((t.type==="tunnel"||t.pathType==="tunnel")&&this.selectedObject.userData.serverId){const p={...this.selectedObject.userData.parameters},w=parseFloat((o=document.getElementById("sel-width"))==null?void 0:o.value),b=parseFloat((c=document.getElementById("sel-height"))==null?void 0:c.value),M=parseFloat((h=document.getElementById("sel-length"))==null?void 0:h.value),v=parseFloat((l=document.getElementById("sel-angle"))==null?void 0:l.value),P=(d=document.getElementById("sel-orientation"))==null?void 0:d.value,O=(r=document.getElementById("sel-color"))==null?void 0:r.value;isNaN(w)||(p.width=w),isNaN(b)||(p.height=b),isNaN(M)||(p.length=M),isNaN(v)||(p.angle=v),P&&(p.orientation=P),O&&this.selectedObject.material&&this.selectedObject.material.color.set(O),this.replaceTunnelGeometry(this.selectedObject,p),await fetch(`/api/mines/${this.mineId}/models/${this.selectedObject.userData.serverId}`,{method:"PUT",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((f=document.querySelector('meta[name="csrf-token"]'))==null?void 0:f.getAttribute("content"))||""},body:JSON.stringify({geometry:{type:"tunnel",params:p}})})}e.status&&(e.status.textContent="Kaydedildi"),this.markSelectionDirty(!1)}catch(p){console.error("Selection save error",p),e.status&&(e.status.style.color="#ff6b6b",e.status.textContent="Kaydetme hatası")}}async init(){try{console.log("%c[SimpleMine3DViewer] Initializing 3D system...","color: green; font-weight: bold;");const e=document.getElementById("loading-container");e&&(e.style.opacity="0",e.style.pointerEvents="none",e.style.transition="opacity .3s",setTimeout(()=>{e&&(e.style.display="none")},350)),this.container.style.display="block",console.log("[SimpleMine3DViewer] Container dimensions:",{clientWidth:this.container.clientWidth,clientHeight:this.container.clientHeight,offsetWidth:this.container.offsetWidth,offsetHeight:this.container.offsetHeight}),(this.container.clientWidth===0||this.container.clientHeight===0)&&console.warn("[SimpleMine3DViewer] Container has zero dimensions, using default sizes"),console.log("[SimpleMine3DViewer] Creating scene..."),this.scene=new Re,this.scene.background=new ve(8900331),console.log("[SimpleMine3DViewer] Scene created:",this.scene),console.log("[SimpleMine3DViewer] Creating camera...");const t=this.container.clientWidth/this.container.clientHeight||16/9;this.camera=new Xe(60,t,.1,500),this.camera.position.set(15,5,25),this.camera.lookAt(0,-2,0),console.log("[SimpleMine3DViewer] Camera created:",{fov:this.camera.fov,aspect:this.camera.aspect,position:this.camera.position,near:this.camera.near,far:this.camera.far}),console.log("[SimpleMine3DViewer] Creating renderer..."),this.renderer=new $e({antialias:!0,alpha:!0,powerPreference:"high-performance"});const i=this.container.clientWidth||800,s=this.container.clientHeight||600;this.renderer.setSize(i,s),this.renderer.setPixelRatio(Math.min(window.devicePixelRatio,2)),this.renderer.shadowMap.enabled=!1,this.renderer.toneMapping=Ne,this.renderer.toneMappingExposure=1.2,this.renderer.outputColorSpace=Qe,this.renderer.domElement.style.width="100%",this.renderer.domElement.style.height="100%",this.renderer.domElement.style.display="block",this.renderer.domElement.style.position="relative",console.log("[SimpleMine3DViewer] Renderer created:",{width:i,height:s,shadowMap:this.renderer.shadowMap.enabled,toneMapping:this.renderer.toneMapping,domElement:this.renderer.domElement}),console.log("[SimpleMine3DViewer] Appending renderer to container..."),this.container.appendChild(this.renderer.domElement),console.log("[SimpleMine3DViewer] Renderer appended successfully"),console.log("[SimpleMine3DViewer] Adding lights..."),this.addLights(),console.log("[SimpleMine3DViewer] Adding test geometry..."),this.addTestGeometry(),console.log("[SimpleMine3DViewer] Setting up controls..."),this.controls=new qe(this.camera,this.renderer.domElement),this.controls.enableDamping=!0,this.controls.dampingFactor=.05,this.controls.enableZoom=!0,this.controls.enablePan=!0,this.controls.enableRotate=!0,this.controls.rotateSpeed=4,this.controls.zoomSpeed=5,this.controls.panSpeed=4.5,this.controls.minDistance=1,this.controls.maxDistance=1e3,this.controls.zoomToCursor=!0,this.controls.maxPolarAngle=Math.PI*.9,this.controls.minPolarAngle=Math.PI*.1,this.controls.maxAzimuthAngle=1/0,this.controls.minAzimuthAngle=-1/0,this.controls.autoRotate=!1,this.controls.autoRotateSpeed=1,this.controls.enableKeys=!0,this.controls.keys={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"},this.controls.mouseButtons={LEFT:ge.ROTATE,MIDDLE:ge.DOLLY,RIGHT:ge.PAN},this.controls.touches={ONE:xe.ROTATE,TWO:xe.DOLLY_PAN},this.controls.target.set(0,-3,0),this.controls.update(),console.log("[SimpleMine3DViewer] OrbitControls initialized with enhanced settings:",this.controls),console.log("[SimpleMine3DViewer] Initializing path drawer..."),this.pathDrawer=new ut(this.scene,this.camera,this.renderer),this.setupPathDrawingEvents(),this.pathEditor=new mt(this.scene,this.camera,this.renderer,this.pathDrawer),this.pathEditor.setCallbacks({onPointChange:(n,o)=>{var c,h;if(this.markPathDirty(o.id||o.pathId),this.selectedObject&&(((c=this.selectedObject.userData.objectData)==null?void 0:c.id)===o.id||((h=this.selectedObject.userData.objectData)==null?void 0:h.pathId)===o.id)){const l=this.selectedObject.userData.objectData;l&&(l.points=n,l.path_points=n,l.length=this.pathDrawer.calculatePathLength(n),this.populateSelectionCard(this.selectedObject,l))}}}),console.log("[SimpleMine3DViewer] Initializing object creator..."),this.objectCreator=new dt(this.scene,this.camera,this.renderer,this),console.log("[SimpleMine3DViewer] Initializing transform controls..."),this.transformControls=new st(this.camera,this.renderer.domElement),this.transformControls.addEventListener("change",()=>this.renderer.render(this.scene,this.camera)),this.transformControls.addEventListener("dragging-changed",n=>{this.controls.enabled=!n.value}),this.scene.add(this.transformControls),setTimeout(()=>{this.setupMiningControls()},100),console.log("[SimpleMine3DViewer] Initializing object selector..."),this.objectSelector=new yt(this.scene,this.camera,this.renderer),this.setupObjectSelection(),this.renderer.domElement.addEventListener("pointerdown",n=>{this.pathEditor&&this.pathEditor.isEditing&&this.pathEditor.pointerDown(n)}),this.renderer.domElement.addEventListener("pointermove",n=>{this.pathEditor&&this.pathEditor.isEditing&&this.pathEditor.pointerMove(n)}),this.renderer.domElement.addEventListener("pointerup",n=>{this.pathEditor&&this.pathEditor.isEditing&&this.pathEditor.pointerUp(n)}),console.log("[SimpleMine3DViewer] Loading mine data..."),await this.loadMineData(),console.log("[SimpleMine3DViewer] Starting render loop..."),this.animate(),console.log("%c[SimpleMine3DViewer] Initialization completed successfully!","color: green; font-weight: bold; font-size: 14px;");const a=document.getElementById("loading-container");a&&a.style.display!=="none"&&(console.log("[SimpleMine3DViewer] Forcing loading container hide at end"),a.remove())}catch(e){throw console.error("%c[SimpleMine3DViewer] Initialization failed:","color: red; font-weight: bold;",{message:e.message,stack:e.stack,name:e.name}),e}}addLights(){console.log("[SimpleMine3DViewer] Adding shadowless lights to scene...");const e=new Ze(4210752,.6);this.scene.add(e),console.log("[SimpleMine3DViewer] Ambient light added:",e);const t=new Ue(16777215,.9);t.position.set(50,50,50),t.castShadow=!1,this.scene.add(t),console.log("[SimpleMine3DViewer] Directional light added (shadowless):",t);const i=new We(8900331,9127187,.5);i.position.set(0,20,0),this.scene.add(i),console.log("[SimpleMine3DViewer] Hemisphere light added:",i),[{pos:[10,2,10],color:16768324,intensity:.4},{pos:[-10,2,10],color:16768324,intensity:.4},{pos:[10,2,-10],color:16768324,intensity:.4},{pos:[-10,2,-10],color:16768324,intensity:.4}].forEach((a,n)=>{const o=new Ke(a.color,a.intensity,25);o.position.set(...a.pos),o.castShadow=!1,this.scene.add(o)}),console.log("[SimpleMine3DViewer] Mining lights added successfully")}setupMiningControls(){console.log("[SimpleMine3DViewer] Setting up mining controls...");const e=document.querySelectorAll(".mining-tool-btn");console.log("[SimpleMine3DViewer] Found tool buttons:",e.length,e),e.forEach(c=>{const h=c.getAttribute("data-tool");console.log("[SimpleMine3DViewer] Setting up button for tool:",h),c.addEventListener("click",l=>{l.preventDefault(),console.log(`🛠️ Mining tool butonuna tıklandı: ${h}`),this.startMiningTool(h)})});const t=document.getElementById("axis-x-btn"),i=document.getElementById("axis-y-btn"),s=document.getElementById("axis-z-btn"),a=document.getElementById("free-draw-btn");t&&t.addEventListener("click",()=>this.setDrawingConstraint("x")),i&&i.addEventListener("click",()=>this.setDrawingConstraint("y")),s&&s.addEventListener("click",()=>this.setDrawingConstraint("z")),a&&a.addEventListener("click",()=>this.setDrawingConstraint("free"));const n=document.getElementById("reset-camera-btn"),o=document.getElementById("toggle-grid-btn");n&&n.addEventListener("click",()=>{this.camera.position.set(15,5,25),this.camera.lookAt(0,-2,0),this.controls.target.set(0,-3,0),this.controls.update()}),o&&o.addEventListener("click",()=>{const c=this.scene.getObjectByName("grid_helper");c&&(c.visible=!c.visible)}),console.log("[SimpleMine3DViewer] Mining controls setup completed")}startMiningTool(e){console.log("🚀 [SimpleMine3DViewer] Starting mining tool:",e),this.isPathDrawingMode&&(console.log("🛑 Mevcut çizim modu durduruluyor..."),this.stopPathDrawing()),this.isCreatingMode&&(console.log("� Mevcut oluşturma modu durduruluyor..."),this.stopCreating()),console.log("🔧 Object creation mode başlatılıyor:",e),this.isCreatingMode=!0,this.controls.enabled=!1,this.objectCreator.startCreating(e),console.log("� Button states güncelleniyor..."),this.updateToolButtonStates(e),console.log("🎉 Mining tool başlatma işlemi tamamlandı:",e)}stopCreating(){this.isCreatingMode&&(this.isCreatingMode=!1,this.controls.enabled=!0,this.objectCreator.stopCreating(),this.updateToolButtonStates(null),console.log("[SimpleMine3DViewer] Creating mode stopped"))}updateToolIndicator(e){const t=document.getElementById("tool-indicator"),i=document.getElementById("tool-name");if(t&&i){const a={tunnel:{icon:"fas fa-mountain",name:"Tünel Kazma"},road:{icon:"fas fa-road",name:"Yol İnşaası"},rail:{icon:"fas fa-train",name:"Ray Döşeme"},conveyor:{icon:"fas fa-conveyor-belt",name:"Konveyör Kurma"}}[e]||{icon:"fas fa-tools",name:"Bilinmeyen Araç"};t.querySelector("i").className=a.icon+" me-2",i.textContent=a.name,t.style.display="block"}}updateToolButtonStates(e){document.querySelectorAll(".mining-tool-btn").forEach(i=>{const s=i.getAttribute("data-tool");s===e?(i.classList.remove("btn-outline-warning","btn-outline-info","btn-outline-success","btn-outline-danger"),i.classList.add("btn-warning")):(i.classList.remove("btn-warning","btn-info","btn-success","btn-danger"),i.classList.add(`btn-outline-${this.getToolColor(s)}`))})}getToolColor(e){return{tunnel:"warning",road:"info",rail:"success",conveyor:"danger"}[e]||"secondary"}setDrawingConstraint(e){console.log("[SimpleMine3DViewer] Setting drawing constraint to:",e),this.activeConstraint=e,document.querySelectorAll("#axis-x-btn, #axis-y-btn, #axis-z-btn, #free-draw-btn").forEach(s=>{s.classList.remove("btn-light","btn-outline-light"),s.classList.add("btn-outline-light")});let i=null;switch(e){case"x":i=document.getElementById("axis-x-btn");break;case"y":i=document.getElementById("axis-y-btn");break;case"z":i=document.getElementById("axis-z-btn");break;case"free":i=document.getElementById("free-draw-btn");break}i&&(i.classList.remove("btn-outline-light"),i.classList.add("btn-light")),this.pathDrawer&&this.pathDrawer.setAxisConstraint(e),console.log("[SimpleMine3DViewer] Constraint set to:",e)}addTestGeometry(){console.log("[SimpleMine3DViewer] Adding test geometry...");try{console.log("[SimpleMine3DViewer] Creating infinite ground plane...");const e=2e4,t=new be(e,e,50,50),i=new pe({color:5668166,transparent:!1}),s=new u(t,i);s.rotation.x=-Math.PI/2,s.position.y=-5,s.receiveShadow=!0,s.name="ground_plane",this.scene.add(s),console.log("[SimpleMine3DViewer] Infinite ground plane added:",s);const a=new Je(e,100,8947848,4473924);a.position.y=-4.9,a.material.opacity=.3,a.material.transparent=!0,this.scene.add(a);const n=new be(e,e),o=new pe({color:9127187,transparent:!0,opacity:.8}),c=new u(n,o);c.rotation.x=-Math.PI/2,c.position.y=-10,c.receiveShadow=!0,c.name="underground_layer",this.scene.add(c),console.log("[SimpleMine3DViewer] Test geometry added successfully"),console.log("[SimpleMine3DViewer] Scene children count:",this.scene.children.length)}catch(e){throw console.error("[SimpleMine3DViewer] Error adding test geometry:",e),e}}async loadMineData(){console.log("[SimpleMine3DViewer] Loading mine data for mine ID:",this.mineId);try{const e=`/api/mines/${this.mineId}/scene-data`;console.log("[SimpleMine3DViewer] Fetching from URL:",e);const t=await fetch(e);if(console.log("[SimpleMine3DViewer] Fetch response:",{ok:t.ok,status:t.status,statusText:t.statusText,headers:Object.fromEntries(t.headers.entries())}),!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);const i=await t.json();console.log("[SimpleMine3DViewer] Mine data loaded successfully:",i),i&&i.models&&console.log("[SimpleMine3DViewer] Processing",i.models.length,"models"),i&&i.layers&&console.log("[SimpleMine3DViewer] Processing",i.layers.length,"layers"),i&&i.paths&&(console.log("[SimpleMine3DViewer] Processing",i.paths.length,"paths"),this.loadPaths(i.paths))}catch(e){console.warn("[SimpleMine3DViewer] Could not load mine data:",{message:e.message,stack:e.stack}),console.log("[SimpleMine3DViewer] Continuing with test geometry only")}}loadPaths(e){console.log("[SimpleMine3DViewer] Loading paths:",e),e.forEach(t=>{if(t.path_points&&t.path_points.length>1){const i=t.path_points.map(a=>new m(a.x,a.y,a.z)),s=this.pathDrawer.createPath({id:t.id,points:i,width:t.width||3,height:t.height||3,color:t.color||"#808080",type:t.type||"tunnel"});s&&this.objectSelector&&this.objectSelector.addSelectableObject(s,{id:t.id,type:"path",name:t.name,pathType:t.type,width:t.width,height:t.height,color:t.color,material:t.material,points:t.path_points,length:this.pathDrawer.calculatePathLength(t.path_points)})}})}animate(){const e=performance.now();requestAnimationFrame(()=>this.animate());try{if(this.controls&&this.controls.update(),this.pathDrawer&&this.pathDrawer.updateLOD(),this._measurementGroup&&this.camera){const s=this.camera.quaternion;this._measurementGroup.traverse(a=>{a.isSprite&&a.quaternion.copy(s)})}this.renderer&&this.scene&&this.camera?this.renderer.render(this.scene,this.camera):console.error("[SimpleMine3DViewer] Missing components for rendering:",{renderer:!!this.renderer,scene:!!this.scene,camera:!!this.camera})}catch(s){console.error("[SimpleMine3DViewer] Render error:",s)}const i=performance.now()-e;this.frameCount||(this.frameCount=0),this.frameCount++,this.frameCount%60===0&&console.log(`[SimpleMine3DViewer] Performance - Frame ${this.frameCount}, Frame time: ${i.toFixed(2)}ms`)}destroy(){this.renderer&&(this.container.removeChild(this.renderer.domElement),this.renderer.dispose())}setupPathDrawingEvents(){const e=this.renderer.domElement;this.boundHandlers={click:t=>this.handleCanvasClick(t),mousemove:t=>this.handleCanvasMouseMove(t),keydown:t=>this.handleKeyDown(t)},e.addEventListener("click",this.boundHandlers.click),e.addEventListener("mousemove",this.boundHandlers.mousemove),document.addEventListener("keydown",this.boundHandlers.keydown)}handleCanvasClick(e){e.preventDefault(),e.stopPropagation(),this.isPathDrawingMode?this.pathDrawer.handleClick(e):this.isCreatingMode?this.updateCreationPosition(e):(this.objectSelector?this.objectSelector.handleClick(e):this.handleObjectSelection(e),!this.selectedObject&&this.objectCreator&&this.objectCreator.previewObject&&this.objectCreator.removePreview())}updateCreationPosition(e){const t=this.renderer.domElement.getBoundingClientRect(),i=new ne;i.x=(e.clientX-t.left)/t.width*2-1,i.y=-((e.clientY-t.top)/t.height)*2+1;const s=new U;s.setFromCamera(i,this.camera);const a=new Me(new m(0,1,0),-2),n=new m;s.ray.intersectPlane(a,n)&&(this.objectCreator.currentPosition.copy(n),this.objectCreator.createPreview(),console.log("[SimpleMine3DViewer] Updated creation position:",n))}handleObjectSelection(e){const t=this.renderer.domElement.getBoundingClientRect(),i=new ne;i.x=(e.clientX-t.left)/t.width*2-1,i.y=-((e.clientY-t.top)/t.height)*2+1;const s=new U;s.setFromCamera(i,this.camera);const a=[];this.scene.traverse(o=>{o.userData&&o.userData.selectable&&o.isMesh&&a.push(o)});const n=s.intersectObjects(a);if(n.length>0){const o=n[0].object;this.selectObject(o)}else this.deselectObject()}selectObject(e){this.selectedObject&&this.deselectObject(),this.selectedObject=e,this.transformControls.attach(e),this.addHighlight(e)}deselectObject(){this.selectedObject&&(this.transformControls.detach(),this.removeHighlight(this.selectedObject),this.selectedObject=null,console.log("[SimpleMine3DViewer] Object deselected")),this.objectCreator&&this.objectCreator.removePreview()}addHighlight(e){e.userData.originalMaterial||(e.userData.originalMaterial=e.material,e.material=e.material.clone(),e.material.emissive.setHex(4473924))}removeHighlight(e){e.userData.originalMaterial&&(e.material.dispose(),e.material=e.userData.originalMaterial,delete e.userData.originalMaterial)}markPathDirty(e){e&&(clearTimeout(this._pathSaveTimer),this.setPathDirtyVisual(!0),this._dirtyPaths.add(e),this._pathSaveTimer=setTimeout(async()=>{const t=this.pathDrawer.getPath(e);if(!t)return;const i=t.userData.pathData||{};try{await this.updatePathToServer(e,{points:i.points||i.path_points}),this._dirtyPaths.delete(e),this._dirtyPaths.size===0&&this.setPathDirtyVisual(!1)}catch{}},600))}setPathDirtyVisual(e){this._dirtyIndicatorEl||(this._dirtyIndicatorEl=document.getElementById("save-path-btn")),this._dirtyIndicatorEl&&(e?this._dirtyIndicatorEl.classList.add("dirty"):this._dirtyIndicatorEl.classList.remove("dirty"))}handleCanvasMouseMove(e){this.isPathDrawingMode&&this.pathDrawer.handleMouseMove(e)}handleKeyDown(e){console.log("[SimpleMine3DViewer] Key pressed:",e.key),e.key==="Escape"?(e.preventDefault(),this.isPathDrawingMode?(this.pathDrawer.stopDrawing(),this.stopPathDrawing()):this.isCreatingMode?this.stopCreating():this.selectedObject&&this.deselectObject()):e.key==="Enter"&&this.isPathDrawingMode?(e.preventDefault(),this.completeCurrentPath()):e.key==="Delete"||e.key==="Backspace"?(e.preventDefault(),this.selectedObject?this.deleteSelectedObject():console.log("[SimpleMine3DViewer] No object selected for deletion")):e.key==="g"||e.key==="G"?(e.preventDefault(),this.selectedObject&&this.transformControls.object&&this.cycleTransformMode()):(e.metaKey||e.ctrlKey)&&(e.key==="z"||e.key==="Z")?(e.preventDefault(),this.pathEditor&&this.pathEditor.isEditing&&this.pathEditor.undo()):(e.metaKey||e.ctrlKey)&&e.shiftKey&&(e.key==="z"||e.key==="Z")?(e.preventDefault(),this.pathEditor&&this.pathEditor.isEditing&&this.pathEditor.redo()):(e.key==="m"||e.key==="M")&&(e.preventDefault(),this.toggleMeasurements())}toggleMeasurements(e=null){const t=e===null?!this.measurementsEnabled:!!e;if(t!==this.measurementsEnabled){if(this.measurementsEnabled=t,!t)this._measurementGroup&&(this._measurementGroup.traverse(i=>{i.geometry&&i.geometry.dispose(),i.material&&i.material.dispose()}),this.scene.remove(this._measurementGroup),this._measurementGroup=null);else if(this._lastMeasuredTunnel){const{object:i,data:s}=this._lastMeasuredTunnel;this.buildTunnelMeasurements(i,s)}console.log("[SimpleMine3DViewer] Measurements toggled ->",this.measurementsEnabled)}}cycleTransformMode(){const e=this.transformControls.getMode(),t=["translate","rotate","scale"],i=t.indexOf(e),s=t[(i+1)%t.length];this.transformControls.setMode(s),console.log("[SimpleMine3DViewer] Transform mode changed to:",s)}async saveObjectToServer(e){var t,i;try{const s={mine_id:this.mineId,name:`${e.userData.type.charAt(0).toUpperCase()+e.userData.type.slice(1)} ${e.userData.id}`,type:e.userData.type,geometry:{type:e.userData.type,...e.userData.parameters},material:{color:e.material.color.getHex(),opacity:e.material.opacity||1},position:[e.position.x,e.position.y,e.position.z],rotation:[e.rotation.x,e.rotation.y,e.rotation.z],scale:[e.scale.x,e.scale.y,e.scale.z],properties:{createdAt:new Date().toISOString(),tool:e.userData.type},visible:!0,order:e.userData.id},a=await fetch(`/api/mines/${this.mineId}/models`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":((t=document.querySelector('meta[name="csrf-token"]'))==null?void 0:t.getAttribute("content"))||"",Accept:"application/json"},body:JSON.stringify(s)});if(a.ok){const n=await a.json();e.userData.serverId=(i=n.data)==null?void 0:i.id,console.log("[SimpleMine3DViewer] Successfully saved object to server:",n),this.showSuccess("Obje başarıyla kaydedildi!")}else throw new Error(`HTTP ${a.status}: ${a.statusText}`)}catch(s){console.error("[SimpleMine3DViewer] Error saving object to server:",s),this.showError("Obje kaydedilemedi: "+s.message)}}showSuccess(e){const t=document.createElement("div");t.style.cssText=`
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #44aa44;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 10000;
        `,t.textContent=e,document.body.appendChild(t),setTimeout(()=>{t.parentNode&&document.body.removeChild(t)},3e3)}showError(e){const t=document.createElement("div");t.style.cssText=`
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #ff4444;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 10000;
        `,t.textContent=e,document.body.appendChild(t),setTimeout(()=>{t.parentNode&&document.body.removeChild(t)},3e3)}deleteSelectedObject(){if(this.selectedObject){const e=this.selectedObject;this.transformControls.detach(),this.scene.remove(e),e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose(),this.objectCreator.createdObjects.has(e.userData.id)&&this.objectCreator.createdObjects.delete(e.userData.id),this.selectedObject=null,console.log("[SimpleMine3DViewer] Object deleted:",e.userData),e.userData.serverId&&this.deleteFromServer(e.userData.serverId)}}async deleteFromServer(e){var t;try{const i=await fetch(`/api/mines/${this.mineId}/models/${e}`,{method:"DELETE",headers:{"X-CSRF-TOKEN":((t=document.querySelector('meta[name="csrf-token"]'))==null?void 0:t.getAttribute("content"))||"",Accept:"application/json"}});if(i.ok)console.log("[SimpleMine3DViewer] Successfully deleted from server"),this.showSuccess("Obje başarıyla silindi!");else throw new Error(`HTTP ${i.status}: ${i.statusText}`)}catch(i){console.error("[SimpleMine3DViewer] Error deleting from server:",i),this.showError("Obje silinemedi: "+i.message)}}setupObjectSelection(){this.objectSelector.setCallbacks({onObjectSelect:(e,t)=>this.onObjectSelected(e,t),onObjectDeselect:e=>this.onObjectDeselected(e),onObjectDelete:e=>this.onObjectDelete(e)})}onObjectSelected(e,t){const i=t||e&&e.userData&&e.userData.objectData||e.userData||{};if(console.log("[SimpleMine3DViewer] Object selected:",i),this.selectedObject=e,this.showSelectionCard(e,i),i&&(i.pathType||i.type==="path")&&this.pathEditor){const s=e.parent&&e.parent.userData&&e.parent.userData.pathData?e.parent:e;this.pathEditor.startEditing(s)}i&&i.type==="tunnel"&&this.buildTunnelMeasurements(e,i)}onObjectDeselected(e){console.log("[SimpleMine3DViewer] Object deselected"),this._measurementGroup&&(this._measurementGroup.traverse(t=>{t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose()}),this.scene.remove(this._measurementGroup),this._measurementGroup=null),this.selectedObject=null,this.hideSelectionCard(),this.pathEditor&&this.pathEditor.isEditing&&this.pathEditor.stopEditing()}async onObjectDelete(e){var i;console.log("[SimpleMine3DViewer] Deleting object:",e.userData.objectData);const t=e.userData.objectData;if(t&&t.id&&t.type==="path")try{const s=await fetch(`/api/mines/${this.mineId}/paths/${t.id}`,{method:"DELETE",headers:{"X-CSRF-TOKEN":((i=document.querySelector('meta[name="csrf-token"]'))==null?void 0:i.getAttribute("content"))||"",Accept:"application/json"}});if(s.ok)this.pathDrawer.removePath(t.id),this.objectSelector.removeSelectableObject(e),console.log("[SimpleMine3DViewer] Path deleted successfully");else throw new Error(`HTTP ${s.status}: ${s.statusText}`)}catch(s){console.error("[SimpleMine3DViewer] Error deleting path:",s),this.showError("Yol silinemedi: "+s.message)}}startPathDrawing(){this.isPathDrawingMode=!0,this.controls.enabled=!1,this.pathDrawer.startDrawing({onPathStart:()=>console.log("[SimpleMine3DViewer] Yol çizimi başladı"),onPathUpdate:e=>console.log("[SimpleMine3DViewer] Yol güncellendi, nokta sayısı:",e.length),onPathComplete:e=>this.onPathDrawingComplete(e)}),this.showPathDrawingUI(!0),console.log("[SimpleMine3DViewer] Yol çizim modu aktif")}stopPathDrawing(){this.isPathDrawingMode=!1,this.controls.enabled=!0,this.pathDrawer.stopDrawing(),this.showPathDrawingUI(!1),console.log("[SimpleMine3DViewer] Yol çizim modu pasif")}completeCurrentPath(){if(this.isPathDrawingMode){console.log("[SimpleMine3DViewer] Manual path completion");const e=this.pathDrawer.completePath();e&&e.length>1&&(this.onPathDrawingComplete(e),this.stopPathDrawing())}}onPathDrawingComplete(e){console.log("[SimpleMine3DViewer] Yol çizimi tamamlandı:",e),this.savePathToServer(e).then(t=>{if(t){const i=this.pathDrawer.createPath({id:t.id,points:e,width:t.width||2.5,height:t.height||2.5,color:t.color||"#808080",type:t.type||"tunnel"});i&&this.objectSelector&&this.objectSelector.addSelectableObject(i,{id:t.id,type:"path",name:t.name,pathType:t.type,width:t.width,height:t.height,color:t.color,material:t.material,points:e.map(s=>({x:s.x,y:s.y,z:s.z})),length:this.pathDrawer.calculatePathLength(e.map(s=>({x:s.x,y:s.y,z:s.z})))})}this.isPathDrawingMode&&this.stopPathDrawing()}).catch(t=>{console.error("[SimpleMine3DViewer] Yol kaydetme hatası:",t),this.showError("Yol kaydedilemedi: "+t.message),this.isPathDrawingMode&&this.stopPathDrawing()})}async savePathToServer(e){var t;try{const i={mine_id:this.mineId,name:`Yol ${Date.now()}`,type:"tunnel",path_points:e.map(o=>({x:o.x,y:o.y,z:o.z})),width:2.5,height:2.5,color:"#808080",status:"active"},s=await fetch(`/api/mines/${this.mineId}/paths`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":((t=document.querySelector('meta[name="csrf-token"]'))==null?void 0:t.getAttribute("content"))||"",Accept:"application/json"},body:JSON.stringify(i)});if(!s.ok){const o=await s.json().catch(()=>({}));throw new Error(o.message||`HTTP ${s.status}: ${s.statusText}`)}const a=await s.json(),n=a.data||a;return console.log("[SimpleMine3DViewer] Yol başarıyla kaydedildi:",n),n}catch(i){throw console.error("[SimpleMine3DViewer] Yol kaydetme hatası:",i),i}}async updatePathToServer(e,t){var i;try{const s={...t};s.points&&!s.path_points&&(s.path_points=s.points.map(c=>({x:c.x,y:c.y,z:c.z})),delete s.points);const a=await fetch(`/api/mines/${this.mineId}/paths/${e}`,{method:"PUT",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":((i=document.querySelector('meta[name="csrf-token"]'))==null?void 0:i.getAttribute("content"))||"",Accept:"application/json"},body:JSON.stringify(s)});if(!a.ok){const c=await a.json().catch(()=>({}));throw new Error(c.message||`HTTP ${a.status}: ${a.statusText}`)}const n=await a.json();console.log("[SimpleMine3DViewer] Yol güncellendi:",n.data||n),this.showSuccess("Yol güncellendi");const o=document.getElementById("save-path-btn");return o&&(o.classList.add("saved-once"),setTimeout(()=>o.classList.remove("saved-once"),400)),n.data||n}catch(s){throw console.error("[SimpleMine3DViewer] Yol güncelleme hatası:",s),this.showError("Yol güncellenemedi: "+s.message),s}}dispose(){if(console.log("[SimpleMine3DViewer] Disposing viewer"),window.removeEventListener("resize",this._resizeHandler),document.removeEventListener("keydown",this._keyHandler),this.renderer&&this.renderer.domElement){const e=this.renderer.domElement;e.removeEventListener("click",this._clickHandler),e.removeEventListener("mousemove",this._mouseMoveHandler)}this.scene&&this.scene.traverse(e=>{e.isMesh&&(e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(t=>t.dispose()):e.material.dispose()))}),this.renderer&&this.renderer.dispose(),this.scene=null,this.camera=null,this.renderer=null}buildTunnelMeasurements(e,t){if(!this.measurementsEnabled||!e||!e.geometry)return;this._measurementGroup&&(this._measurementGroup.traverse(g=>{g.geometry&&g.geometry.dispose(),g.material&&g.material.dispose()}),this.scene.remove(this._measurementGroup));const i=new Be;i.name="tunnel_measurements",this._measurementGroup=i,this.scene.add(i),this._lastMeasuredTunnel={object:e,data:t};const s=t.parameters||{};s.orientation==="yatay"&&(s.orientation="horizontal"),s.orientation==="dikey"&&(s.orientation="vertical");const a=s.width||3,n=s.height||3,o=s.length||10,c=s.orientation||"horizontal",h=c==="vertical"?"y":"z";let l,d;c==="vertical"?(l=a,d=a):(l=a,d=n);const r=e.position.clone(),f=new N({color:43775,transparent:!0,opacity:.85,depthTest:!1,depthWrite:!1}),p=new N({color:30668,transparent:!0,opacity:.45,depthTest:!1,depthWrite:!1}),w="#00aaff",b=(g,D,x)=>{const C=new se().setFromPoints([g,D]);return new A(C,x)},M=Math.max(1,this.measurementStep||5);{const x=(0/o-.5)*o;let C;if(h==="z"){const j=r.y+d/2+.02;C=new m(r.x+l/2+.2,j,r.z+x)}else{const j=r.z-d/2-.02;C=new m(r.x+l/2+.2,r.y+x,j)}this._addSpriteLabel("0m",C,w,i)}for(let g=M;g<o+.001;g+=M){const x=(g/o-.5)*o;let C,j;if(h==="z"){const L=r.y+d/2+.02;C=new m(r.x-l/2,L,r.z+x),j=new m(r.x+l/2,L,r.z+x)}else{const L=r.z-d/2-.02;C=new m(r.x-l/2,r.y+x,L),j=new m(r.x+l/2,r.y+x,L)}const W=b(C,j,f);i.add(W),this._addSpriteLabel(`${g}m`,j.clone().add(new m(.2,.2,0)),w,i)}const v=.5,P=.5,O=0;for(let g=-l/2;g<=l/2+.001;g+=v){let D,x;if(h==="z"){const C=r.z+O;D=new m(r.x+g,r.y-d/2+.01,C),x=new m(r.x+g,r.y+d/2+.01,C)}else{const C=r.z+.01;D=new m(r.x+g,r.y-o/2,C),x=new m(r.x+g,r.y+o/2,C)}i.add(b(D,x,p))}for(let g=-d/2;g<=d/2+.001;g+=P){let D,x;if(h==="z"){const C=r.z+O;D=new m(r.x-l/2,r.y+g,C+.01),x=new m(r.x+l/2,r.y+g,C+.01)}else{const C=r.y,j=C-o/2,W=C+o/2,L=r.z+g;D=new m(r.x-l/2,j,L),x=new m(r.x+l/2,W,L)}i.add(b(D,x,p))}try{const g=h==="z"?"Z Ekseni":"Y Ekseni",D=h==="z"?new m(r.x+l/2+.6,r.y+d/2+.4,r.z):new m(r.x+l/2+.6,r.y,r.z-d/2-.6);this._addSpriteLabel(g,D,"#ffaa00",i)}catch{}}replaceTunnelGeometry(e,t){if(!this.objectCreator)return;t.orientation==="yatay"&&(t.orientation="horizontal"),t.orientation==="dikey"&&(t.orientation="vertical");const i={...e.userData.parameters||{}},s=this.objectCreator.createGeometry("tunnel",t);e.geometry&&e.geometry.dispose(),e.geometry=s,e.userData.parameters={...t},this.measurementsEnabled&&(this.buildTunnelMeasurements(e,{type:"tunnel",parameters:t}),i.orientation!==t.orientation&&requestAnimationFrame(()=>{this.measurementsEnabled&&this.buildTunnelMeasurements(e,{type:"tunnel",parameters:t})}))}_addSpriteLabel(e,t,i,s){const a=document.createElement("canvas"),n=256;a.width=n,a.height=n;const o=a.getContext("2d");o.fillStyle="rgba(0,0,0,0.0)",o.fillRect(0,0,n,n),o.fillStyle=i||"#ffffff",o.font="48px Arial",o.textAlign="center",o.textBaseline="middle",o.fillText(e,n/2,n/2);const c=new et(a);c.needsUpdate=!0;const h=new tt({map:c,transparent:!0}),l=new it(h);l.scale.set(1.5,1.5,1.5),l.position.copy(t),s.add(l)}showPathDrawingUI(e){console.log("[SimpleMine3DViewer] Path drawing UI:",e?"show":"hide");const t=document.getElementById("path-controls"),i=document.getElementById("draw-path-btn"),s=document.getElementById("path-btn-text");e?(t&&(t.style.display="block"),s&&(s.textContent="Çizimi Bitir"),i&&(i.classList.remove("btn-outline-warning"),i.classList.add("btn-warning"))):(t&&(t.style.display="none"),s&&(s.textContent="Yol Çiz"),i&&(i.classList.remove("btn-warning"),i.classList.add("btn-outline-warning")));const a=document.getElementById("path-drawing-overlay");if(e&&!a){const n=document.createElement("div");n.id="path-drawing-overlay",n.innerHTML=`
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                           background: rgba(0,0,0,0.8); color: white; padding: 20px; border-radius: 10px;
                           text-align: center; z-index: 1000;">
                    <h5>Yol Çizim Modu</h5>
                    <p>Yol noktalarını tıklayarak belirleyin</p>
                    <small>Enter: Tamamla | Escape: İptal</small>
                </div>
            `,this.container.appendChild(n)}else!e&&a&&a.remove()}showError(e){const t=document.getElementById("error-content");t?(t.textContent=e,new bootstrap.Modal(document.getElementById("errorModal")).show()):alert(e)}getTypeDisplayName(e){return{tunnel:"Tünel",road:"Yol",rail:"Ray",conveyor:"Konveyör"}[e]||e}editSelectedObject(){if(this.selectedObject){const e=this.selectedObject.userData.objectData;console.log("[SimpleMine3DViewer] Editing object:",e),alert("Düzenleme özelliği yakında gelecek!")}}deleteSelectedObject(){this.selectedObject&&confirm("Bu objeyi silmek istediğinizden emin misiniz?")&&this.objectSelector.deleteSelectedObject()}setCameraPreset(e){switch(e){case"overview":this.camera.position.set(25,15,35),this.controls.target.set(0,-2,0);break;case"side":this.camera.position.set(40,0,0),this.controls.target.set(0,-3,0);break;case"top":this.camera.position.set(0,30,0),this.controls.target.set(0,-3,0);break;case"underground":this.camera.position.set(10,-40,25),this.controls.target.set(0,-45,0);break;case"close":this.camera.position.set(8,2,12),this.controls.target.set(0,-1,0);break;default:this.camera.position.set(15,5,25),this.controls.target.set(0,-3,0)}this.controls.update()}animateCameraTo(e,t,i=1500){if(!this.camera||!this.controls)return;const s=this.camera.position.clone(),a=this.controls.target.clone(),n=new m().copy(e),o=new m().copy(t);let c=null;const h=l=>{c||(c=l);const d=l-c,r=Math.min(d/i,1),f=r<.5?4*r*r*r:(r-1)*(2*r-2)*(2*r-2)+1;this.camera.position.lerpVectors(s,n,f),this.controls.target.lerpVectors(a,o,f),this.controls.update(),r<1&&requestAnimationFrame(h)};requestAnimationFrame(h)}}window.SimpleMine3DViewer=ft;
